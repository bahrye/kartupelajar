<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  var currentToken = "";
  var studentList = [];
  var modalSiswa;

  // --- [BARU] LOGIKA SESI (SESSION MANAGEMENT) ---
  
  // 1. Cek Sesi saat halaman pertama kali dimuat
  document.addEventListener('DOMContentLoaded', function() {
    checkSession();
  });

  function checkSession() {
    var sessionData = localStorage.getItem('appSekolahSession');
    
    if (sessionData) {
      var session = JSON.parse(sessionData);
      var now = new Date().getTime();

      // Cek apakah sesi masih berlaku (kurang dari 3 jam)
      if (now < session.expiry) {
        // Restore data dari storage
        currentToken = session.token;
        document.getElementById('schoolTitle').innerText = session.sekolah;
        
        // Langsung masuk dashboard tanpa login lagi
        switchPage('dashboard');
        loadTableData();
      } else {
        // Jika expired, hapus data sampah
        localStorage.removeItem('appSekolahSession');
      }
    }
  }

  // 2. Fungsi Simpan Sesi (Dipanggil saat Login Sukses)
  function saveSession(token, namaSekolah) {
    var now = new Date().getTime();
    var expiryTime = now + (3 * 60 * 60 * 1000); // 3 Jam dalam milidetik

    var session = {
      token: token,
      sekolah: namaSekolah,
      expiry: expiryTime
    };

    localStorage.setItem('appSekolahSession', JSON.stringify(session));
  }

  // 3. Fungsi Logout (Menghapus Sesi)
  function logoutApp() {
    localStorage.removeItem('appSekolahSession'); // Hapus sesi
    location.reload(); // Refresh halaman kembali ke login
  }

  // --- NAVIGATION ---
  function switchPage(page) {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('registerPage').style.display = 'none';
    document.getElementById('dashboardPage').style.display = 'none';

    if(page === 'login') document.getElementById('loginPage').style.display = 'block';
    if(page === 'register') document.getElementById('registerPage').style.display = 'block';
    if(page === 'dashboard') {
      document.getElementById('dashboardPage').style.display = 'block';
      // Inisialisasi Modal hanya jika belum ada
      if(!modalSiswa) {
        modalSiswa = new bootstrap.Modal(document.getElementById('studentModal'));
      }
      
      // Load data pengaturan dari server
      loadSettings(); 
    }
  }

  // --- AUTHENTICATION ---
  function runLogin() {
    var email = document.getElementById('loginEmail').value;
    var pass = document.getElementById('loginPass').value;
    var btn = document.getElementById('btnLogin');
    btn.disabled = true; btn.innerText = "Loading...";

    google.script.run.withSuccessHandler(function(res){
        btn.disabled = false; btn.innerText = "Login";
        if(res.status === 'success') {
          // [UBAH DISINI] Simpan sesi sebelum pindah halaman
          saveSession(res.token, res.sekolah);
          
          currentToken = res.token;
          document.getElementById('schoolTitle').innerText = res.sekolah;
          switchPage('dashboard');
          loadTableData(); 
        } else { showToast(res.message, 'bg-danger'); }
      }).loginSchool(email, pass);
  }

  function runRegister() {
    var form = {
      namaSekolah: document.getElementById('regSekolah').value,
      email: document.getElementById('regEmail').value,
      password: document.getElementById('regPass').value
    };
    if(!form.namaSekolah || !form.email) return showToast("Isi semua data!", 'bg-warning');

    var btn = document.getElementById('btnReg');
    btn.disabled = true; btn.innerText = "Memproses...";
    
    google.script.run.withSuccessHandler(function(res){
      btn.disabled = false; btn.innerText = "Buat Database";
      if(res.status === 'success') {
        alert(res.message); switchPage('login');
      } else { showToast(res.message, 'bg-danger'); }
    }).registerSchool(form);
  }

  // --- DATA SISWA & TABLE ---
  function loadTableData() {
    var tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Mengambil data...</td></tr>";

    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success') {
        studentList = res.data;
        renderTable();
      } else {
        tbody.innerHTML = "<tr><td colspan='8' class='text-danger'>Error: "+res.message+"</td></tr>";
      }
    }).getStudents(currentToken);
  }

  function renderTable() {
    var tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = "";
    
    if(studentList.length === 0) {
      tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Belum ada data siswa.</td></tr>";
      return;
    }

    studentList.forEach((s, index) => {
      var btnEdit = `<button class="btn btn-warning btn-sm me-1" onclick="openModalEdit(${index})"><i class="bi bi-pencil"></i></button>`;
      var btnDel  = `<button class="btn btn-danger btn-sm" onclick="deleteData(${index})"><i class="bi bi-trash"></i></button>`;
      // Cek apakah ada foto (panjang string > 20 dianggap URL valid)
      // Tambahkan atribut onerror untuk menangani gambar error
      var img = (s.foto && s.foto.length > 20) 
        ? `<img src="${s.foto}" width="50" height="60" class="border rounded" style="object-fit:cover; background:#eee;" onerror="this.onerror=null;this.src='https://via.placeholder.com/50?text=Err';">` 
        : '<span class="text-muted">-</span>';
      var ttl = `${s.tmp_lahir}, ${s.tgl_lahir}`;

      var row = `<tr>
        <td>${index+1}</td>
        <td>${btnEdit}${btnDel}</td>
        <td class="fw-bold">${s.nama}</td>
        <td>${s.nisn}</td>
        <td>${ttl}</td>
        <td>${s.jk}</td>
        <td class="small">${s.alamat}</td>
        <td>${img}</td>
      </tr>`;
      tbody.innerHTML += row;
    });
  }

  // --- CRUD MODAL OPERATIONS ---
  
  // Fungsi Preview Gambar saat user memilih file
  function previewImage(input) {
    var preview = document.getElementById('imgPreview');
    var txt = document.getElementById('txtNoFoto');
    
    if (input.files && input.files[0]) {
      var reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        txt.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    } else {
      // Jika batal pilih, kembalikan ke kondisi sebelumnya (jika ada foto lama)
      var old = document.getElementById('inpFotoOld').value;
      if(old) {
        preview.src = old;
        preview.style.display = 'block';
        txt.style.display = 'none';
      } else {
        preview.style.display = 'none';
        txt.style.display = 'block';
      }
    }
  }

  function openModalAdd() {
    document.getElementById('modalTitle').innerText = "Tambah Siswa";
    document.getElementById('editRow').value = ""; 
    
    document.getElementById('inpNama').value = "";
    document.getElementById('inpNISN').value = "";
    document.getElementById('inpTmpLahir').value = "";
    document.getElementById('inpTglLahir').value = "";
    document.getElementById('inpJK').value = "L";
    document.getElementById('inpKelas').value = "";
    document.getElementById('inpAlamat').value = "";
    
    // Reset Foto
    document.getElementById('inpFotoFile').value = "";
    document.getElementById('inpFotoOld').value = "";
    document.getElementById('imgPreview').style.display = 'none';
    document.getElementById('txtNoFoto').style.display = 'block';
    
    modalSiswa.show();
  }

  function openModalEdit(index) {
    var s = studentList[index];
    document.getElementById('modalTitle').innerText = "Edit Siswa";
    document.getElementById('editRow').value = s.row;
    
    document.getElementById('inpNama').value = s.nama;
    document.getElementById('inpNISN').value = s.nisn;
    document.getElementById('inpTmpLahir').value = s.tmp_lahir;
    document.getElementById('inpTglLahir').value = s.tgl_lahir;
    document.getElementById('inpJK').value = s.jk;
    document.getElementById('inpKelas').value = s.kelas;
    document.getElementById('inpAlamat').value = s.alamat;
    
    // Set Foto Lama
    document.getElementById('inpFotoFile').value = ""; // Reset input file
    document.getElementById('inpFotoOld').value = s.foto;
    
    if(s.foto && s.foto.length > 5) {
      document.getElementById('imgPreview').src = s.foto;
      document.getElementById('imgPreview').style.display = 'block';
      document.getElementById('txtNoFoto').style.display = 'none';
    } else {
      document.getElementById('imgPreview').style.display = 'none';
      document.getElementById('txtNoFoto').style.display = 'block';
    }
    
    modalSiswa.show();
  }

  function saveStudent() {
    var fileInput = document.getElementById('inpFotoFile');
    var file = fileInput.files[0];

    // Ambil nilai text form dulu
    var data = {
      row: document.getElementById('editRow').value,
      nama: document.getElementById('inpNama').value,
      nisn: document.getElementById('inpNISN').value,
      tmp_lahir: document.getElementById('inpTmpLahir').value,
      tgl_lahir: document.getElementById('inpTglLahir').value,
      jk: document.getElementById('inpJK').value,
      kelas: document.getElementById('inpKelas').value,
      alamat: document.getElementById('inpAlamat').value,
      foto: document.getElementById('inpFotoOld').value // Default pakai foto lama
    };

    if(!data.nama) return alert("Nama wajib diisi");
    
    // UI Loading
    var btn = document.getElementById('btnSimpanSiswa');
    var oriText = btn.innerText;
    btn.disabled = true; 
    btn.innerText = "Mengupload...";

    // Helper untuk kirim ke backend
    var sendToBackend = function(finalData) {
      var handler = function(res) {
        btn.disabled = false; btn.innerText = oriText;
        if(res.status === 'success') {
          showToast(res.message, 'bg-success');
          modalSiswa.hide();
          loadTableData(); 
        } else {
          alert(res.message);
        }
      };

      if(finalData.row === "") {
        google.script.run.withSuccessHandler(handler).addStudent(currentToken, finalData);
      } else {
        google.script.run.withSuccessHandler(handler).editStudent(currentToken, finalData);
      }
    };

    // Cek apakah user upload file baru?
    if (file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        // Ganti properti foto dengan data base64 gambar baru
        data.foto = e.target.result; 
        sendToBackend(data);
      };
      reader.readAsDataURL(file);
    } else {
      // Tidak ada file baru, kirim data apa adanya (pakai foto lama/kosong)
      sendToBackend(data);
    }
  }

  function deleteData(index) {
    if(!confirm("Hapus siswa " + studentList[index].nama + "?")) return;
    
    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success') {
        showToast("Terhapus.", 'bg-success');
        loadTableData();
      } else {
        alert(res.message);
      }
    }).deleteStudent(currentToken, studentList[index].row);
  }

  // --- CONFIGURATION FUNCTIONS (BARU) ---

  // 1. Ambil nilai dari Form
  function getConfigs() {
    return {
      yayasan: document.getElementById('confYayasan').value,
      alamat1: document.getElementById('confAlamat1').value,
      alamat2: document.getElementById('confAlamat2').value,
      telp: document.getElementById('confTelp').value,    // Baru
      email: document.getElementById('confEmail').value,  // Baru
      tgl: document.getElementById('confTgl').value,
      kepala: document.getElementById('confKepala').value,
      nip: document.getElementById('confNIP').value,
      logoKiri: document.getElementById('confLogoKiri').value,
      logoKanan: document.getElementById('confLogoKanan').value,
      stempel: document.getElementById('confStempel').value,
      ttd: document.getElementById('confTTD').value,
    };
  }

  // 2. Fungsi Simpan ke Server
  function runSaveSettings() {
    var conf = getConfigs();
    var btn = document.getElementById('btnSaveConfig');
    var txt = btn.innerHTML;
    
    btn.disabled = true; btn.innerText = "Menyimpan...";

    google.script.run.withSuccessHandler(function(res){
      btn.disabled = false; btn.innerHTML = txt;
      if(res.status === 'success') {
        showToast(res.message, 'bg-success');
      } else {
        showToast(res.message, 'bg-danger');
      }
    }).saveSchoolConfig(currentToken, conf);
  }

  // 3. Fungsi Load dari Server
  function loadSettings() {
    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success' && res.data) {
        var d = res.data;
        // Isi form jika datanya ada di database
        if(d.yayasan) document.getElementById('confYayasan').value = d.yayasan;
        if(d.alamat1) document.getElementById('confAlamat1').value = d.alamat1;
        if(d.alamat2) document.getElementById('confAlamat2').value = d.alamat2;
        if(d.telp) document.getElementById('confTelp').value = d.telp;
        if(d.email) document.getElementById('confEmail').value = d.email;
        if(d.tgl) document.getElementById('confTgl').value = d.tgl;
        if(d.kepala) document.getElementById('confKepala').value = d.kepala;
        if(d.nip) document.getElementById('confNIP').value = d.nip;
        if(d.logoKiri) document.getElementById('confLogoKiri').value = d.logoKiri;
        if(d.logoKanan) document.getElementById('confLogoKanan').value = d.logoKanan;
        if(d.stempel) document.getElementById('confStempel').value = d.stempel;
        if(d.ttd) document.getElementById('confTTD').value = d.ttd;
        
        // Render ulang preview setelah data masuk
        renderPreview();
      }
    }).getSchoolConfig(currentToken);
  }

  // 4. Update Tampilan Kartu Belakang (createBackCardHTML)
  function createBackCardHTML(conf) {
    var sekolah = document.getElementById('schoolTitle').innerText || "MADRASAH CONTOH";
    var yayasan = conf.yayasan || "YAYASAN PENDIDIKAN";
    var alamat1 = conf.alamat1 || "NSM: ... NPSN: ...";
    var alamat2 = conf.alamat2 || "Alamat Kota...";
    
    // UPDATE LOGIC DISINI
    // Gunakan input conf.telp, jika kosong fallback ke conf.nip (untuk jaga2), lalu placeholder
    var kontakHP = conf.telp ? conf.telp : (conf.nip !== '-' ? conf.nip : '0812xxxx'); 
    var email = conf.email || "admin@sekolah.com";
    
    var logoKiri = conf.logoKiri;
    var logoKanan = conf.logoKanan;

    return `
      <div class="back-card">
        <div class="back-header-flat">
           <div class="back-logo-box"><img src="${logoKiri}" onerror="this.style.display='none'"></div>
           <div class="back-header-text">
             <div class="txt-yayasan">${yayasan}</div>
             <div class="txt-sekolah">${sekolah}</div>
             <div class="txt-alamat">${alamat1}<br>${alamat2}</div>
           </div>
           <div class="back-logo-box"><img src="${logoKanan}" onerror="this.style.display='none'"></div>
        </div>

        <div class="back-body">
          <div>
            <div class="rules-title">KETENTUAN - KETENTUAN</div>
            <ol class="rules-list">
              <li>Kartu ini berlaku selama menjadi Siswa di <strong>${sekolah.toUpperCase()}</strong>.</li>
              <li>Siswa wajib mematuhi Tata Tertib Madrasah & Perpustakaan.</li>
              <li>Siswa bertanggung jawab penuh atas penggunaan kartu ini.</li>
              <li>Kehilangan kartu harap segera melapor ke Tata Usaha/Kesiswaan.</li>
              <li>Kartu wajib dibawa setiap hari sekolah/kegiatan madrasah.</li>
            </ol>
          </div>

          <div class="back-footer-container">
            <div class="cp-title">Contact Person:</div>
            <table class="cp-table">
              <tr>
                <td class="cp-label">No Telp/HP</td>
                <td class="cp-sep">:</td>
                <td class="cp-val">${kontakHP}</td>
              </tr>
              <tr>
                <td class="cp-label">Email</td>
                <td class="cp-sep">:</td>
                <td class="cp-val">${email}</td>
              </tr>
            </table>
          </div>

        </div>
      </div>
    `;
  }

  // --- UPDATE FUNGSI CREATE CARD HTML ---
  function createCardHTML(s, conf) {
    var ttl = `${s.tmp_lahir}, ${s.tgl_lahir}`;
    var sekolah = document.getElementById('schoolTitle').innerText;

    // 1. Logic Cek Foto
    // Cek apakah string foto valid (panjang > 20 dan mengandung 'http')
    var hasPhoto = (s.foto && s.foto.length > 20 && s.foto.includes('http'));
    
    // Jika ada foto, buat tag IMG dengan class 'real-photo'
    // Jika tidak ada, kosongkan string ini.
    var photoImgHtml = hasPhoto ? `<img src="${s.foto}" class="real-photo">` : '';

    // Logic TTD & Stempel (Tetap sama)
    var ttdHtml = conf.ttd ? `<img src="${conf.ttd}" class="sig-img">` : `<div class="sig-placeholder"></div>`;
    var stempelHtml = conf.stempel ? `<img src="${conf.stempel}" class="stamp-img">` : ``;

    return `
      <div class="id-card temp-madrasah">
        <div class="madrasah-header">
          <div class="logo-box"><img src="${conf.logoKiri}" onerror="this.style.display='none'"></div>
          <div class="header-text">
            <div class="txt-yayasan">${conf.yayasan}</div>
            <div class="txt-sekolah">${sekolah}</div>
            <div class="txt-alamat">${conf.alamat1}<br>${conf.alamat2}</div>
          </div>
          <div class="logo-box"><img src="${conf.logoKanan}" onerror="this.style.display='none'"></div>
        </div>
        <div class="card-title-bar">KARTU PELAJAR</div>
        <div class="card-body-custom">
          
          <div class="photo-area">
             <i class="bi bi-person-fill ph-icon"></i>
             <div class="ph-text">3 X 4</div>
             
             ${photoImgHtml}
          </div>
          <div class="right-panel">
            <div class="data-area">
              <table>
                <tr><td>Nama</td><td>:</td><td><strong>${s.nama}</strong></td></tr>
                <tr><td>NISN</td><td>:</td><td>${s.nisn}</td></tr>
                <tr><td>TTL</td><td>:</td><td>${ttl}</td></tr>
                <tr><td>L/P</td><td>:</td><td>${s.jk}</td></tr>
                <tr><td>Alamat</td><td>:</td><td>${s.alamat}</td></tr>
              </table>
            </div>
            <div class="signature-area">
              ${stempelHtml}
              <div style="position:relative; z-index:2">
                <div>${conf.tgl}</div>
                <div>Kepala Madrasah,</div>
                ${ttdHtml}
                <div class="head-name">${conf.kepala}</div>
                <div class="head-nip">NIP. ${conf.nip}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // --- FUNGSI RENDER PREVIEW (SMART FADE - NO BLUR) ---
  function renderPreview() {
    var dummy = { 
      nama: "PREVIEW SISWA", nisn: "0012345678", 
      tmp_lahir: "Jakarta", tgl_lahir: "2010-01-01", 
      jk: "L", kelas: "X-A", 
      alamat: "Jl. Contoh No. 1", foto: "" 
    };
    var conf = getConfigs();

    var htmlDepan = createCardHTML(dummy, conf);
    var htmlBelakang = createBackCardHTML(conf);

    // Cek Container
    var switcher = document.getElementById('cardSwitcher');
    
    if (!switcher) {
      // Struktur HTML Baru (Switch Container)
      document.getElementById('previewContainer').innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center p-3">
          
          <div class="switch-container" id="cardSwitcher" onclick="toggleSwitchCard()">
            <div class="switch-face face-front" id="viewDepan">
               ${htmlDepan}
            </div>
            <div class="switch-face face-back" id="viewBelakang">
               ${htmlBelakang}
            </div>
          </div>

          <div class="mt-4 text-center text-muted small user-select-none">
              <i class="bi bi-arrow-repeat"></i> Klik kartu untuk melihat sisi belakang
          </div>

        </div>
      `;
      switcher = document.getElementById('cardSwitcher');
    } else {
      // Update isi jika container sudah ada
      document.getElementById('viewDepan').innerHTML = htmlDepan;
      document.getElementById('viewBelakang').innerHTML = htmlBelakang;
    }

    // Logic Otomatis (Cek Input User)
    var activeEl = document.activeElement;
    if (activeEl && activeEl.id) {
      // Jika ngetik HP/Email -> Tampilkan Belakang (tambah class show-back)
      if (activeEl.id === 'confTelp' || activeEl.id === 'confEmail') {
         switcher.classList.add('show-back');
      } 
      // Jika ngetik Config lain -> Tampilkan Depan (hapus class show-back)
      else if (activeEl.id.startsWith('conf')) {
         switcher.classList.remove('show-back');
      }
    }
  }

  // Fungsi Toggle Manual
  function toggleSwitchCard() {
    var switcher = document.getElementById('cardSwitcher');
    if(switcher) switcher.classList.toggle('show-back');
  }

  // --- FUNGSI TOGGLE KLIK KARTU ---
  function togglePreview(element) {
    var depan = document.getElementById('viewDepan');
    var belakang = document.getElementById('viewBelakang');
    
    // 1. Efek visual 'Tekan' (mengecil sedikit saat diklik)
    element.style.transform = "scale(0.95)";
    
    setTimeout(function() {
      // 2. Logic Tukar Tampilan
      if (depan.style.display !== 'none') {
        depan.style.display = 'none';
        belakang.style.display = 'block';
      } else {
        depan.style.display = 'block';
        belakang.style.display = 'none';
      }
      
      // 3. Kembalikan ukuran normal
      element.style.transform = "scale(1)";
    }, 150); // Delay sedikit agar efek tekan terasa
  }

  function renderAllCards() {
    var container = document.getElementById('cardContainer');
    container.innerHTML = "";
    
    if(studentList.length === 0) {
      container.innerHTML = "<div class='alert alert-warning'>Belum ada data siswa. Silakan input di menu Data Siswa.</div>";
      return;
    }

    var conf = getConfigs();
    var html = "";

    // Loop setiap siswa
    studentList.forEach(s => {
      
      // [PERUBAHAN DISINI] Gunakan class 'print-row'
      html += `<div class="print-row">`;
      
      // Render Bagian Depan
      html += createCardHTML(s, conf);
      
      // Render Bagian Belakang
      html += createBackCardHTML(conf);
      
      html += `</div>`; // Tutup wrapper
    });

    container.innerHTML = html;
  }

  // --- UTILS ---
  function showToast(msg, bgClass) {
    var el = document.getElementById('toastNotif');
    el.className = `toast align-items-center text-white border-0 ${bgClass}`;
    document.getElementById('toastMsg').innerText = msg;
    new bootstrap.Toast(el).show();
  }

  // --- FITUR IMPORT & EXPORT EXCEL (VERSI PRO) ---

  // 1. Download Template Excel (Format Text & Auto Width)
  function downloadTemplateExcel() {
    // Data Header & Dummy
    // Perhatikan: NISN diberi tanda petik satu (') di depan pada data dummy
    // agar user paham itu harus teks.
    var data = [
      ["Nama", "NISN", "TempatLahir", "TglLahir", "JK", "Kelas", "Alamat"], 
      ["Siswa Contoh", "0012345678", "Jakarta", "2010-01-31", "L", "X-A", "Jl. Mawar No 1"]
    ];

    // Buat Workbook & Worksheet
    var wb = XLSX.utils.book_new();
    var ws = XLSX.utils.aoa_to_sheet(data);

    // --- FORMATTING KOLOM ---
    // Kita atur lebar kolom agar rapi
    var wscols = [
      {wch: 25}, // A: Nama
      {wch: 15}, // B: NISN
      {wch: 15}, // C: TmpLahir
      {wch: 15}, // D: TglLahir
      {wch: 5},  // E: JK
      {wch: 10}, // F: Kelas
      {wch: 30}  // G: Alamat
    ];
    ws['!cols'] = wscols;

    // --- PAKSA FORMAT TEXT (PENTING!) ---
    // Kita loop semua sel yang ada datanya untuk memastikan formatnya Text (@)
    // Range deteksi otomatis dari data
    var range = XLSX.utils.decode_range(ws['!ref']);
    
    for (var R = 0; R <= range.e.r; ++R) {
      for (var C = 0; C <= range.e.c; ++C) {
        var cellAddress = {c: C, r: R};
        var cellRef = XLSX.utils.encode_cell(cellAddress);
        
        if (!ws[cellRef]) continue;

        // Kolom B (NISN, index 1) & D (TglLahir, index 3) -> PAKSA TEXT
        if (C === 1 || C === 3) {
          ws[cellRef].z = '@';   // Format cell Excel jadi "Text"
          ws[cellRef].t = 's';   // Tipe data library jadi "String"
        }
      }
    }

    XLSX.utils.book_append_sheet(wb, ws, "TemplateSiswa");
    XLSX.writeFile(wb, "Template_Data_Siswa.xlsx");
  }

  // 2. Helper: Konversi Serial Date Excel ke YYYY-MM-DD
  function excelDateToJSDate(serial) {
    // Jika input sudah string (misal: "2023-01-01"), kembalikan langsung
    if (typeof serial === 'string' || serial instanceof String) return serial;
    
    // Jika kosong/null
    if (!serial) return "";

    // Rumus konversi hari Excel ke JS Date
    // Excel mulai dari 30 Des 1899 (biasanya), JS 1 Jan 1970
    var utc_days  = Math.floor(serial - 25569);
    var utc_value = utc_days * 86400;                                 
    var date_info = new Date(utc_value * 1000);

    // Format ke YYYY-MM-DD
    // Perlu penyesuaian timezone sedikit karena pembulatan, tapi biasanya aman
    // Kita ambil bagian YMD nya saja secara manual agar tidak kena geser jam
    var year = date_info.getFullYear();
    var month = ("0" + (date_info.getMonth() + 1)).slice(-2);
    var day = ("0" + date_info.getDate()).slice(-2);

    return `${year}-${month}-${day}`;
  }

  // 3. Proses Upload Excel (Smart Reading)
  function processImportExcel(input) {
    var file = input.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, {type: 'array'});
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];

      // Ambil data JSON mentah (termasuk format aslinya)
      var jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, raw: true});

      parseAndUploadExcel(jsonData);
    };
    reader.readAsArrayBuffer(file);
    input.value = ""; 
  }

  // 4. Parsing Data & Kirim
  function parseAndUploadExcel(rows) {
    // Hapus header
    if (rows.length > 0) rows.shift();

    var dataUpload = [];
    
    rows.forEach(function(row) {
      // Validasi baris: Minimal kolom Nama (index 0) terisi
      if (row.length > 0 && row[0]) {
        
        // --- LOGIKA NISN (Pastikan jadi String) ---
        var rawNISN = row[1] ? row[1].toString().trim() : "";
        // Bersihkan karakter aneh jika ada (misal tanda petik sisa copy paste)
        rawNISN = rawNISN.replace(/^'|'$/g, '');

        // --- LOGIKA TANGGAL LAHIR (Smart Convert) ---
        var rawTgl = row[3];
        var finalTgl = "";

        // Cek apakah Excel mengirim Angka (Serial Date) atau Teks
        if (typeof rawTgl === 'number') {
          // Jika angka (misal 44567), convert ke YYYY-MM-DD
          finalTgl = excelDateToJSDate(rawTgl);
        } else if (typeof rawTgl === 'string') {
          // Jika teks, ambil apa adanya (asumsi user tulis YYYY-MM-DD)
          finalTgl = rawTgl.trim();
        }

        var obj = {
          nama: row[0].toString().trim(),
          nisn: rawNISN,
          tmp_lahir: row[2] ? row[2].toString().trim() : "",
          tgl_lahir: finalTgl, // Hasil konversi pintar
          jk: row[4] ? row[4].toString().trim() : "",
          kelas: row[5] ? row[5].toString().trim() : "",
          alamat: row[6] ? row[6].toString().trim() : ""
        };
        dataUpload.push(obj);
      }
    });

    if (dataUpload.length === 0) {
      alert("Data kosong atau format tidak terbaca!");
      return;
    }

    if(!confirm("Akan mengimport " + dataUpload.length + " data siswa. Lanjutkan?")) return;

    // UI Loading
    var tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Mengupload & Memproses Data...</td></tr>";

    // Kirim ke Backend
    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success') {
        alert(res.message);
        loadTableData();
      } else {
        alert("Gagal: " + res.message);
        loadTableData();
      }
    }).importBulkStudents(currentToken, dataUpload);
  }

  // --- FITUR BULK UPLOAD FOTO (ZIP) ---
  // --- LOGIC MODAL PANDUAN FOTO ---

  var modalGuide; // Variabel global untuk modal

  function showPhotoGuide() {
    // Inisialisasi modal jika belum ada
    if (!modalGuide) {
      modalGuide = new bootstrap.Modal(document.getElementById('modalPhotoGuide'));
    }
    modalGuide.show();
  }

  function proceedPhotoUpload() {
    // 1. Sembunyikan Modal
    if (modalGuide) modalGuide.hide();
    
    // 2. Klik Input File yang tersembunyi secara otomatis
    setTimeout(function() {
      document.getElementById('filePhotoZip').click();
    }, 300); // Delay sedikit agar animasi modal selesai
  }

  function uploadPhotoZip(input) {
    var file = input.files[0];
    if (!file) return;

    // Validasi
    if (file.type.indexOf('zip') === -1 && !file.name.endsWith('.zip')) {
      alert("Harap upload file format .ZIP");
      input.value = "";
      return;
    }

    // Konfirmasi
    if(!confirm("Pastikan nama file foto di dalam ZIP sesuai dengan NISN siswa (Contoh: 12345678.jpg).\nLanjutkan upload?")) return;

    var btn = input.previousElementSibling; // Tombol triggernya
    var oriText = btn.innerHTML;
    btn.disabled = true; 
    btn.innerHTML = "<i class='bi bi-hourglass-split'></i> Mengupload...";
    
    // Tampilkan loading di tabel agar terlihat prosesnya
    var tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Sedang mengekstrak & mencocokkan foto... (Bisa memakan waktu)</td></tr>";

    // Baca File sebagai Base64
    var reader = new FileReader();
    reader.onload = function(e) {
      var base64Data = e.target.result.split(',')[1]; // Ambil datanya saja tanpa header data:application/zip...
      
      // Kirim ke Server
      google.script.run.withSuccessHandler(function(res){
        btn.disabled = false; btn.innerHTML = oriText;
        input.value = ""; // Reset
        
        if(res.status === 'success') {
          alert(res.message);
          loadTableData(); // Refresh tabel untuk melihat foto baru
        } else {
          alert("Gagal: " + res.message);
          loadTableData();
        }
      }).processBulkPhotos(currentToken, base64Data);
    };
    
    reader.readAsDataURL(file);
  }

  // --- LOGIC MODAL PANDUAN EXCEL ---
  var modalExcel; // Variabel global

  function showExcelGuide() {
    if (!modalExcel) {
      modalExcel = new bootstrap.Modal(document.getElementById('modalExcelGuide'));
    }
    modalExcel.show();
  }

  function proceedExcelUpload() {
    // 1. Tutup Modal
    if (modalExcel) modalExcel.hide();
    
    // 2. Klik Input File Excel yang tersembunyi
    setTimeout(function() {
      document.getElementById('fileImportExcel').click();
    }, 300);
  }

</script>
