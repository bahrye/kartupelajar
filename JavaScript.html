<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // --- GLOBAL VARIABLES ---
  var currentToken = "";
  var studentList = [];

  // --- NAVIGATION ---
  function switchPage(page) {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('registerPage').style.display = 'none';
    document.getElementById('dashboardPage').style.display = 'none';

    if(page === 'login') document.getElementById('loginPage').style.display = 'block';
    if(page === 'register') document.getElementById('registerPage').style.display = 'block';
    if(page === 'dashboard') document.getElementById('dashboardPage').style.display = 'block';
  }

  // --- REGISTER FUNCTION ---
  function runRegister() {
    // Ambil Value
    var nama = document.getElementById('regSekolah').value;
    var email = document.getElementById('regEmail').value;
    var pass = document.getElementById('regPass').value;

    if(!nama || !email || !pass) {
      showToast("Harap isi semua kolom!"); return;
    }

    // UI Loading
    var btn = document.getElementById('btnReg');
    var oriText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "Memproses (Mohon Tunggu)...";

    // Panggil Google Script
    google.script.run
      .withSuccessHandler(function(res) {
        btn.disabled = false;
        btn.innerText = oriText;
        
        if(res.status === 'success') {
          alert(res.message);
          // Reset form manual
          document.getElementById('regSekolah').value = "";
          document.getElementById('regEmail').value = "";
          document.getElementById('regPass').value = "";
          switchPage('login');
        } else {
          showToast(res.message);
        }
      })
      .withFailureHandler(function(err) {
        btn.disabled = false;
        btn.innerText = oriText;
        showToast("Error Koneksi: " + err.message);
      })
      .registerSchool({namaSekolah: nama, email: email, password: pass});
  }

  // --- LOGIN FUNCTION ---
  function runLogin() {
    var email = document.getElementById('loginEmail').value;
    var pass = document.getElementById('loginPass').value;
    var btn = document.getElementById('btnLogin');

    btn.disabled = true;
    btn.innerText = "Validasi...";

    google.script.run
      .withSuccessHandler(function(res){
        btn.disabled = false;
        btn.innerText = "Login";

        if(res.status === 'success') {
          currentToken = res.token;
          document.getElementById('schoolTitle').innerText = res.sekolah;
          switchPage('dashboard');
          fetchDataSiswa(); // Ambil data
        } else {
          showToast(res.message);
        }
      })
      .loginSchool(email, pass);
  }

  // --- FETCH DATA ---
  function fetchDataSiswa() {
    document.getElementById('cardContainer').innerHTML = "<p>Sedang memuat data siswa...</p>";
    
    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success') {
        studentList = res.data;
        renderCards();
      } else {
        document.getElementById('cardContainer').innerHTML = "<p class='text-danger'>Gagal: " + res.message + "</p>";
      }
    }).getStudents(currentToken);
  }

  // --- RENDER CARDS (VERSI FINAL + STEMPEL) ---
  function renderCards() {
    var template = document.getElementById('templateSelect').value;
    var container = document.getElementById('cardContainer');
    var namaSekolah = document.getElementById('schoolTitle').innerText;
    var configPanel = document.getElementById('madrasahConfig');

    // 1. Toggle Panel Config
    if (template === 'temp-madrasah') {
      if(configPanel) configPanel.style.display = 'block';
    } else {
      if(configPanel) configPanel.style.display = 'none';
    }

    // 2. Ambil Value Config
    var yayasan = document.getElementById('confYayasan') ? document.getElementById('confYayasan').value : "YAYASAN PENDIDIKAN";
    var alamat1 = document.getElementById('confAlamat1') ? document.getElementById('confAlamat1').value : "NSM: ... NPSN: ...";
    var alamat2 = document.getElementById('confAlamat2') ? document.getElementById('confAlamat2').value : "Alamat Sekolah...";
    var tglTTD  = document.getElementById('confTgl') ? document.getElementById('confTgl').value : "Jakarta, 14 Juli 2025";
    var nmKepala= document.getElementById('confKepala') ? document.getElementById('confKepala').value : "Nama Kepala";
    var nipKepala=document.getElementById('confNIP') ? document.getElementById('confNIP').value : "-";
    
    // URL Gambar (Logo, TTD, Stempel)
    var logoKiri = document.getElementById('confLogoKiri') ? document.getElementById('confLogoKiri').value : "";
    var logoKanan= document.getElementById('confLogoKanan') ? document.getElementById('confLogoKanan').value : "";
    var ttdImg   = document.getElementById('confTTD') ? document.getElementById('confTTD').value : "";
    // INPUT BARU
    var stempelImg = document.getElementById('confStempel') ? document.getElementById('confStempel').value : "";

    container.innerHTML = "";

    if(studentList.length === 0) {
      container.innerHTML = "<div class='alert alert-warning'>Belum ada data siswa.</div>";
      return;
    }

    studentList.forEach(s => {
      var foto = s.foto && s.foto.includes('http') ? s.foto : 'https://via.placeholder.com/100x120?text=Foto';
      var html = "";

      if (template === 'temp-madrasah') {
        // --- TEMPLATE MADRASAH ---
        html = `
          <div class="id-card temp-madrasah">
            <div class="madrasah-header">
              <div class="logo-box"><img src="${logoKiri}" onerror="this.style.display='none'"></div>
              <div class="header-text">
                <div class="txt-yayasan">${yayasan}</div>
                <div class="txt-sekolah">${namaSekolah}</div>
                <div class="txt-alamat">${alamat1}<br>${alamat2}</div>
              </div>
              <div class="logo-box"><img src="${logoKanan}" onerror="this.style.display='none'"></div>
            </div>

            <div class="card-title-bar">KARTU PELAJAR</div>

            <div class="card-body-custom">
              <div class="photo-area"><img src="${foto}"></div>
              
              <div class="right-panel">
                <div class="data-area">
                  <table>
                    <tr><td>Nama</td><td>:</td><td><strong>${s.nama}</strong></td></tr>
                    <tr><td>NIS/NISN</td><td>:</td><td>${s.nis}</td></tr>
                    <tr><td>TTL</td><td>:</td><td>${s.ttl}</td></tr>
                    <tr><td>Kelas</td><td>:</td><td>${s.kelas}</td></tr>
                    <tr><td>Alamat</td><td>:</td><td>${s.alamat}</td></tr>
                  </table>
                </div>

                <div class="signature-area">
                  <img src="${stempelImg}" class="stamp-img" onerror="this.style.display='none'">
                  
                  <div style="position:relative; z-index:2">
                    <div>${tglTTD}</div>
                    <div>Kepala Madrasah,</div>
                    <img src="${ttdImg}" class="sig-img" onerror="this.style.display='none'"> 
                    <div class="head-name">${nmKepala}</div>
                    <div class="head-nip">NIP. ${nipKepala}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        // --- TEMPLATE LAIN ---
        html = `
          <div class="id-card ${template}">
            <div class="head-text">${namaSekolah}</div>
            <div class="content">
              <img src="${foto}" class="p-img">
              <div class="details">
                <div><strong>${s.nama}</strong></div>
                <div>NIS: ${s.nis}</div>
                <div>Kelas: ${s.kelas}</div>
                <div class="small">${s.ttl}</div>
              </div>
            </div>
          </div>
        `;
      }
      container.innerHTML += html;
    });
  }

  function showToast(msg) {
    document.getElementById('errorMsg').innerText = msg;
    var toastEl = document.getElementById('toastError');
    var toast = new bootstrap.Toast(toastEl);
    toast.show();
  }
</script>
