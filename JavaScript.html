<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  var currentToken = "";
  var studentList = [];
  var modalSiswa;

  // --- NAVIGATION ---
  function switchPage(page) {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('registerPage').style.display = 'none';
    document.getElementById('dashboardPage').style.display = 'none';

    if(page === 'login') document.getElementById('loginPage').style.display = 'block';
    if(page === 'register') document.getElementById('registerPage').style.display = 'block';
    if(page === 'dashboard') {
      document.getElementById('dashboardPage').style.display = 'block';
      modalSiswa = new bootstrap.Modal(document.getElementById('studentModal'));
      
      // Load data pengaturan dari server
      loadSettings(); 
    }
  }

  // --- AUTHENTICATION ---
  function runLogin() {
    var email = document.getElementById('loginEmail').value;
    var pass = document.getElementById('loginPass').value;
    var btn = document.getElementById('btnLogin');
    btn.disabled = true; btn.innerText = "Loading...";

    google.script.run.withSuccessHandler(function(res){
        btn.disabled = false; btn.innerText = "Login";
        if(res.status === 'success') {
          currentToken = res.token;
          document.getElementById('schoolTitle').innerText = res.sekolah;
          switchPage('dashboard');
          loadTableData(); // Load Data Awal
        } else { showToast(res.message, 'bg-danger'); }
      }).loginSchool(email, pass);
  }

  function runRegister() {
    var form = {
      namaSekolah: document.getElementById('regSekolah').value,
      email: document.getElementById('regEmail').value,
      password: document.getElementById('regPass').value
    };
    if(!form.namaSekolah || !form.email) return showToast("Isi semua data!", 'bg-warning');

    var btn = document.getElementById('btnReg');
    btn.disabled = true; btn.innerText = "Memproses...";
    
    google.script.run.withSuccessHandler(function(res){
      btn.disabled = false; btn.innerText = "Buat Database";
      if(res.status === 'success') {
        alert(res.message); switchPage('login');
      } else { showToast(res.message, 'bg-danger'); }
    }).registerSchool(form);
  }

  // --- DATA SISWA & TABLE ---
  function loadTableData() {
    var tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Mengambil data...</td></tr>";

    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success') {
        studentList = res.data;
        renderTable();
      } else {
        tbody.innerHTML = "<tr><td colspan='8' class='text-danger'>Error: "+res.message+"</td></tr>";
      }
    }).getStudents(currentToken);
  }

  function renderTable() {
    var tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = "";
    
    if(studentList.length === 0) {
      tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Belum ada data siswa.</td></tr>";
      return;
    }

    studentList.forEach((s, index) => {
      var btnEdit = `<button class="btn btn-warning btn-sm me-1" onclick="openModalEdit(${index})"><i class="bi bi-pencil"></i></button>`;
      var btnDel  = `<button class="btn btn-danger btn-sm" onclick="deleteData(${index})"><i class="bi bi-trash"></i></button>`;
      // Cek apakah ada foto (panjang string > 20 dianggap URL valid)
      // Tambahkan atribut onerror untuk menangani gambar error
      var img = (s.foto && s.foto.length > 20) 
        ? `<img src="${s.foto}" width="50" height="60" class="border rounded" style="object-fit:cover; background:#eee;" onerror="this.onerror=null;this.src='https://via.placeholder.com/50?text=Err';">` 
        : '<span class="text-muted">-</span>';
      var ttl = `${s.tmp_lahir}, ${s.tgl_lahir}`;

      var row = `<tr>
        <td>${index+1}</td>
        <td>${btnEdit}${btnDel}</td>
        <td class="fw-bold">${s.nama}</td>
        <td>${s.nisn}</td>
        <td>${ttl}</td>
        <td>${s.jk}</td>
        <td class="small">${s.alamat}</td>
        <td>${img}</td>
      </tr>`;
      tbody.innerHTML += row;
    });
  }

  // --- CRUD MODAL OPERATIONS ---
  
  // Fungsi Preview Gambar saat user memilih file
  function previewImage(input) {
    var preview = document.getElementById('imgPreview');
    var txt = document.getElementById('txtNoFoto');
    
    if (input.files && input.files[0]) {
      var reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        txt.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    } else {
      // Jika batal pilih, kembalikan ke kondisi sebelumnya (jika ada foto lama)
      var old = document.getElementById('inpFotoOld').value;
      if(old) {
        preview.src = old;
        preview.style.display = 'block';
        txt.style.display = 'none';
      } else {
        preview.style.display = 'none';
        txt.style.display = 'block';
      }
    }
  }

  function openModalAdd() {
    document.getElementById('modalTitle').innerText = "Tambah Siswa";
    document.getElementById('editRow').value = ""; 
    
    document.getElementById('inpNama').value = "";
    document.getElementById('inpNISN').value = "";
    document.getElementById('inpTmpLahir').value = "";
    document.getElementById('inpTglLahir').value = "";
    document.getElementById('inpJK').value = "L";
    document.getElementById('inpKelas').value = "";
    document.getElementById('inpAlamat').value = "";
    
    // Reset Foto
    document.getElementById('inpFotoFile').value = "";
    document.getElementById('inpFotoOld').value = "";
    document.getElementById('imgPreview').style.display = 'none';
    document.getElementById('txtNoFoto').style.display = 'block';
    
    modalSiswa.show();
  }

  function openModalEdit(index) {
    var s = studentList[index];
    document.getElementById('modalTitle').innerText = "Edit Siswa";
    document.getElementById('editRow').value = s.row;
    
    document.getElementById('inpNama').value = s.nama;
    document.getElementById('inpNISN').value = s.nisn;
    document.getElementById('inpTmpLahir').value = s.tmp_lahir;
    document.getElementById('inpTglLahir').value = s.tgl_lahir;
    document.getElementById('inpJK').value = s.jk;
    document.getElementById('inpKelas').value = s.kelas;
    document.getElementById('inpAlamat').value = s.alamat;
    
    // Set Foto Lama
    document.getElementById('inpFotoFile').value = ""; // Reset input file
    document.getElementById('inpFotoOld').value = s.foto;
    
    if(s.foto && s.foto.length > 5) {
      document.getElementById('imgPreview').src = s.foto;
      document.getElementById('imgPreview').style.display = 'block';
      document.getElementById('txtNoFoto').style.display = 'none';
    } else {
      document.getElementById('imgPreview').style.display = 'none';
      document.getElementById('txtNoFoto').style.display = 'block';
    }
    
    modalSiswa.show();
  }

  function saveStudent() {
    var fileInput = document.getElementById('inpFotoFile');
    var file = fileInput.files[0];

    // Ambil nilai text form dulu
    var data = {
      row: document.getElementById('editRow').value,
      nama: document.getElementById('inpNama').value,
      nisn: document.getElementById('inpNISN').value,
      tmp_lahir: document.getElementById('inpTmpLahir').value,
      tgl_lahir: document.getElementById('inpTglLahir').value,
      jk: document.getElementById('inpJK').value,
      kelas: document.getElementById('inpKelas').value,
      alamat: document.getElementById('inpAlamat').value,
      foto: document.getElementById('inpFotoOld').value // Default pakai foto lama
    };

    if(!data.nama) return alert("Nama wajib diisi");
    
    // UI Loading
    var btn = document.getElementById('btnSimpanSiswa');
    var oriText = btn.innerText;
    btn.disabled = true; 
    btn.innerText = "Mengupload...";

    // Helper untuk kirim ke backend
    var sendToBackend = function(finalData) {
      var handler = function(res) {
        btn.disabled = false; btn.innerText = oriText;
        if(res.status === 'success') {
          showToast(res.message, 'bg-success');
          modalSiswa.hide();
          loadTableData(); 
        } else {
          alert(res.message);
        }
      };

      if(finalData.row === "") {
        google.script.run.withSuccessHandler(handler).addStudent(currentToken, finalData);
      } else {
        google.script.run.withSuccessHandler(handler).editStudent(currentToken, finalData);
      }
    };

    // Cek apakah user upload file baru?
    if (file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        // Ganti properti foto dengan data base64 gambar baru
        data.foto = e.target.result; 
        sendToBackend(data);
      };
      reader.readAsDataURL(file);
    } else {
      // Tidak ada file baru, kirim data apa adanya (pakai foto lama/kosong)
      sendToBackend(data);
    }
  }

  function deleteData(index) {
    if(!confirm("Hapus siswa " + studentList[index].nama + "?")) return;
    
    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success') {
        showToast("Terhapus.", 'bg-success');
        loadTableData();
      } else {
        alert(res.message);
      }
    }).deleteStudent(currentToken, studentList[index].row);
  }

  // --- CONFIGURATION FUNCTIONS (BARU) ---

  // 1. Ambil nilai dari Form
  function getConfigs() {
    return {
      yayasan: document.getElementById('confYayasan').value,
      alamat1: document.getElementById('confAlamat1').value,
      alamat2: document.getElementById('confAlamat2').value,
      telp: document.getElementById('confTelp').value,    // Baru
      email: document.getElementById('confEmail').value,  // Baru
      tgl: document.getElementById('confTgl').value,
      kepala: document.getElementById('confKepala').value,
      nip: document.getElementById('confNIP').value,
      logoKiri: document.getElementById('confLogoKiri').value,
      logoKanan: document.getElementById('confLogoKanan').value,
      stempel: document.getElementById('confStempel').value,
      ttd: document.getElementById('confTTD').value,
    };
  }

  // 2. Fungsi Simpan ke Server
  function runSaveSettings() {
    var conf = getConfigs();
    var btn = document.getElementById('btnSaveConfig');
    var txt = btn.innerHTML;
    
    btn.disabled = true; btn.innerText = "Menyimpan...";

    google.script.run.withSuccessHandler(function(res){
      btn.disabled = false; btn.innerHTML = txt;
      if(res.status === 'success') {
        showToast(res.message, 'bg-success');
      } else {
        showToast(res.message, 'bg-danger');
      }
    }).saveSchoolConfig(currentToken, conf);
  }

  // 3. Fungsi Load dari Server
  function loadSettings() {
    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success' && res.data) {
        var d = res.data;
        // Isi form jika datanya ada di database
        if(d.yayasan) document.getElementById('confYayasan').value = d.yayasan;
        if(d.alamat1) document.getElementById('confAlamat1').value = d.alamat1;
        if(d.alamat2) document.getElementById('confAlamat2').value = d.alamat2;
        if(d.telp) document.getElementById('confTelp').value = d.telp;
        if(d.email) document.getElementById('confEmail').value = d.email;
        if(d.tgl) document.getElementById('confTgl').value = d.tgl;
        if(d.kepala) document.getElementById('confKepala').value = d.kepala;
        if(d.nip) document.getElementById('confNIP').value = d.nip;
        if(d.logoKiri) document.getElementById('confLogoKiri').value = d.logoKiri;
        if(d.logoKanan) document.getElementById('confLogoKanan').value = d.logoKanan;
        if(d.stempel) document.getElementById('confStempel').value = d.stempel;
        if(d.ttd) document.getElementById('confTTD').value = d.ttd;
        
        // Render ulang preview setelah data masuk
        renderPreview();
      }
    }).getSchoolConfig(currentToken);
  }

  // 4. Update Tampilan Kartu Belakang (createBackCardHTML)
  function createBackCardHTML(conf) {
    var sekolah = document.getElementById('schoolTitle').innerText || "MADRASAH CONTOH";
    var yayasan = conf.yayasan || "YAYASAN PENDIDIKAN";
    var alamat1 = conf.alamat1 || "NSM: ... NPSN: ...";
    var alamat2 = conf.alamat2 || "Alamat Kota...";
    
    // UPDATE LOGIC DISINI
    // Gunakan input conf.telp, jika kosong fallback ke conf.nip (untuk jaga2), lalu placeholder
    var kontakHP = conf.telp ? conf.telp : (conf.nip !== '-' ? conf.nip : '0812xxxx'); 
    var email = conf.email || "admin@sekolah.com";
    
    var logoKiri = conf.logoKiri;
    var logoKanan = conf.logoKanan;

    return `
      <div class="back-card">
        <div class="back-header-flat">
           <div class="back-logo-box"><img src="${logoKiri}" onerror="this.style.display='none'"></div>
           <div class="back-header-text">
             <div class="txt-yayasan">${yayasan}</div>
             <div class="txt-sekolah">${sekolah}</div>
             <div class="txt-alamat">${alamat1}<br>${alamat2}</div>
           </div>
           <div class="back-logo-box"><img src="${logoKanan}" onerror="this.style.display='none'"></div>
        </div>

        <div class="back-body">
          <div>
            <div class="rules-title">KETENTUAN - KETENTUAN</div>
            <ol class="rules-list">
              <li>Kartu ini berlaku selama menjadi Siswa di <strong>${sekolah.toUpperCase()}</strong>.</li>
              <li>Siswa wajib mematuhi Tata Tertib Madrasah & Perpustakaan.</li>
              <li>Siswa bertanggung jawab penuh atas penggunaan kartu ini.</li>
              <li>Kehilangan kartu harap segera melapor ke Tata Usaha/Kesiswaan.</li>
              <li>Kartu wajib dibawa setiap hari sekolah/kegiatan madrasah.</li>
            </ol>
          </div>

          <div class="back-footer-container">
            <div class="cp-title">Contact Person:</div>
            <table class="cp-table">
              <tr>
                <td class="cp-label">No Telp/HP</td>
                <td class="cp-sep">:</td>
                <td class="cp-val">${kontakHP}</td>
              </tr>
              <tr>
                <td class="cp-label">Email</td>
                <td class="cp-sep">:</td>
                <td class="cp-val">${email}</td>
              </tr>
            </table>
          </div>

        </div>
      </div>
    `;
  }

  function createCardHTML(s, conf) {
    var foto = s.foto && s.foto.includes('http') ? s.foto : 'https://via.placeholder.com/100x120?text=Foto';
    var ttl = `${s.tmp_lahir}, ${s.tgl_lahir}`;
    var sekolah = document.getElementById('schoolTitle').innerText;

    // Logic TTD
    var ttdHtml = conf.ttd ? `<img src="${conf.ttd}" class="sig-img">` : `<div class="sig-placeholder"></div>`;
    var stempelHtml = conf.stempel ? `<img src="${conf.stempel}" class="stamp-img">` : ``;

    return `
      <div class="id-card temp-madrasah">
        <div class="madrasah-header">
          <div class="logo-box"><img src="${conf.logoKiri}" onerror="this.style.display='none'"></div>
          <div class="header-text">
            <div class="txt-yayasan">${conf.yayasan}</div>
            <div class="txt-sekolah">${sekolah}</div>
            <div class="txt-alamat">${conf.alamat1}<br>${conf.alamat2}</div>
          </div>
          <div class="logo-box"><img src="${conf.logoKanan}" onerror="this.style.display='none'"></div>
        </div>
        <div class="card-title-bar">KARTU PELAJAR</div>
        <div class="card-body-custom">
          <div class="photo-area"><img src="${foto}"></div>
          <div class="right-panel">
            <div class="data-area">
              <table>
                <tr><td>Nama</td><td>:</td><td><strong>${s.nama}</strong></td></tr>
                <tr><td>NISN</td><td>:</td><td>${s.nisn}</td></tr>
                <tr><td>TTL</td><td>:</td><td>${ttl}</td></tr>
                <tr><td>L/P</td><td>:</td><td>${s.jk}</td></tr>
                <tr><td>Alamat</td><td>:</td><td>${s.alamat}</td></tr>
              </table>
            </div>
            <div class="signature-area">
              ${stempelHtml}
              <div style="position:relative; z-index:2">
                <div>${conf.tgl}</div>
                <div>Kepala Madrasah,</div>
                ${ttdHtml}
                <div class="head-name">${conf.kepala}</div>
                <div class="head-nip">NIP. ${conf.nip}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // --- FUNGSI RENDER PREVIEW (DENGAN LAYOUT FIX) ---
  function renderPreview() {
    // 1. Data Dummy & Config
    var dummy = { 
      nama: "PREVIEW SISWA", nisn: "0012345678", 
      tmp_lahir: "Jakarta", tgl_lahir: "2010-01-01", 
      jk: "L", kelas: "X-A", 
      alamat: "Jl. Contoh No. 1", foto: "" 
    };
    var conf = getConfigs();

    var htmlDepan = createCardHTML(dummy, conf);
    var htmlBelakang = createBackCardHTML(conf);

    // 2. Cek apakah wadah Flip sudah ada?
    var flipper = document.getElementById('cardFlipper');
    
    if (!flipper) {
      // PERBAIKAN DISINI: Tambahkan class 'd-flex flex-column align-items-center'
      // Ini memaksa susunan Vertikal yang Rapi
      document.getElementById('previewContainer').innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center p-3">
          
          <div class="flip-container" onclick="toggleFlipManual()">
            <div class="flip-inner" id="cardFlipper">
              <div class="flip-face flip-front" id="viewDepan">
                 ${htmlDepan}
              </div>
              <div class="flip-face flip-back" id="viewBelakang">
                 ${htmlBelakang}
              </div>
            </div>
          </div>

          <div class="mt-4 text-center text-muted small user-select-none">
              <i class="bi bi-arrow-repeat"></i> Klik kartu untuk memutar (Flip)
          </div>

        </div>
      `;
      flipper = document.getElementById('cardFlipper');
    } else {
      // Update isi saja jika container sudah ada
      document.getElementById('viewDepan').innerHTML = htmlDepan;
      document.getElementById('viewBelakang').innerHTML = htmlBelakang;
    }

    // 3. Logic Otomatis Deteksi Input (Tetap Sama)
    var activeEl = document.activeElement;
    if (activeEl && activeEl.id) {
      if (activeEl.id === 'confTelp' || activeEl.id === 'confEmail') {
         flipper.classList.add('flipped');
      } else if (activeEl.id.startsWith('conf')) {
         flipper.classList.remove('flipped');
      }
    }
  }

  // Fungsi Manual
  function toggleFlipManual() {
    var flipper = document.getElementById('cardFlipper');
    if(flipper) flipper.classList.toggle('flipped');
  }

  // --- FUNGSI TOGGLE KLIK KARTU ---
  function togglePreview(element) {
    var depan = document.getElementById('viewDepan');
    var belakang = document.getElementById('viewBelakang');
    
    // 1. Efek visual 'Tekan' (mengecil sedikit saat diklik)
    element.style.transform = "scale(0.95)";
    
    setTimeout(function() {
      // 2. Logic Tukar Tampilan
      if (depan.style.display !== 'none') {
        depan.style.display = 'none';
        belakang.style.display = 'block';
      } else {
        depan.style.display = 'block';
        belakang.style.display = 'none';
      }
      
      // 3. Kembalikan ukuran normal
      element.style.transform = "scale(1)";
    }, 150); // Delay sedikit agar efek tekan terasa
  }

  // --- UPDATE: RENDER ALL CARDS (DEPAN & BELAKANG) ---
  function renderAllCards() {
    var container = document.getElementById('cardContainer');
    container.innerHTML = "";
    
    if(studentList.length === 0) {
      container.innerHTML = "<div class='alert alert-warning'>Belum ada data siswa. Silakan input di menu Data Siswa.</div>";
      return;
    }

    var conf = getConfigs();
    var html = "";

    // Loop setiap siswa
    studentList.forEach(s => {
      // 1. Buat Wrapper untuk Pasangan Kartu (Depan & Belakang)
      // class 'd-flex' membuat mereka berdampingan (kiri-kanan)
      // style 'break-inside: avoid' mencegah kartu terpotong saat print pindah halaman
      html += `<div class="d-flex gap-2 mb-4 align-items-start" style="break-inside: avoid; page-break-inside: avoid;">`;
      
      // 2. Render Bagian Depan
      html += createCardHTML(s, conf);
      
      // 3. Render Bagian Belakang
      html += createBackCardHTML(conf);
      
      html += `</div>`; // Tutup wrapper
    });

    container.innerHTML = html;
  }

  // --- UTILS ---
  function showToast(msg, bgClass) {
    var el = document.getElementById('toastNotif');
    el.className = `toast align-items-center text-white border-0 ${bgClass}`;
    document.getElementById('toastMsg').innerText = msg;
    new bootstrap.Toast(el).show();
  }
</script>
