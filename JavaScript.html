<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  var currentToken = "";
  var studentList = [];
  var modalSiswa;

  // [BARU] Variabel penanda status loading
  var isLoading = false;

  // --- [BARU] LOGIKA SESI (SESSION MANAGEMENT) ---
  
  // Konfigurasi: Sesi Timeout 1 Jam (dalam milidetik)
  // Logika: Jika user aktif, timer ini akan terus di-reset.
  // Jika user diam total selama 1 jam, sesi akan habis.
  var SESSION_TIMEOUT = 1 * 60 * 60 * 1000; 
  
  var lastActivityUpdate = 0; // Penanda waktu update terakhir agar tidak spam storage
  var sessionInterval;        // Variabel untuk interval cek background

  // 1. Cek Sesi saat halaman pertama kali dimuat
  document.addEventListener('DOMContentLoaded', function() {
    checkSession();
  });

  function checkSession() {
    var sessionData = localStorage.getItem('appSekolahSession');
    
    if (sessionData) {
      var session = JSON.parse(sessionData);
      var now = new Date().getTime();

      // Cek apakah sesi masih berlaku
      if (now < session.expiry) {
        // Restore data dari storage
        currentToken = session.token;
        document.getElementById('schoolTitle').innerText = session.sekolah;
        
        // Langsung masuk dashboard tanpa login lagi
        switchPage('dashboard');
        loadTableData();
        
        // [PENTING] Mulai pantau aktifitas user agar sesi tidak mati jika user kerja
        startActivityMonitor();

      } else {
        // Jika expired, hapus data sampah
        localStorage.removeItem('appSekolahSession');
      }
    }
  }

  // 2. Fungsi Simpan Sesi (Dipanggil saat Login Sukses)
  function saveSession(token, namaSekolah) {
    var now = new Date().getTime();
    var expiryTime = now + SESSION_TIMEOUT; 

    var session = {
      token: token,
      sekolah: namaSekolah,
      expiry: expiryTime
    };

    localStorage.setItem('appSekolahSession', JSON.stringify(session));
    
    // Mulai monitor aktifitas setelah login
    startActivityMonitor();
  }

  // Variabel global untuk modal logout (agar tidak di-init berulang kali)
  var modalLogout;

  // 1. Fungsi Pemicu (Hanya Membuka Pop-up)
  function logoutApp() {
    // Inisialisasi modal jika belum ada
    if (!modalLogout) {
      modalLogout = new bootstrap.Modal(document.getElementById('modalLogoutConfirm'));
    }
    modalLogout.show();
  }

  // 2. Fungsi Eksekusi (Dijalankan saat tombol "Ya, Keluar" diklik)
  function executeLogout() {
    // Sembunyikan modal dulu agar rapi
    if (modalLogout) modalLogout.hide();

    // --- PROSES PEMBERSIHAN (Sama seperti sebelumnya) ---
    
    // A. Hapus Sesi & Interval
    localStorage.removeItem('appSekolahSession'); 
    if(sessionInterval) clearInterval(sessionInterval); 

    // B. Reset Variabel Global
    currentToken = "";
    studentList = [];
    
    // C. Bersihkan Tampilan Dashboard
    document.getElementById('schoolTitle').innerText = "Sekolah"; 
    var tbody = document.querySelector('#studentTable tbody');
    if(tbody) tbody.innerHTML = ""; 
    var cardContainer = document.getElementById('cardContainer');
    if(cardContainer) cardContainer.innerHTML = "";
    
    // D. Reset Form Login
    document.getElementById('loginEmail').value = "";
    document.getElementById('loginPass').value = "";

    // E. Pindah ke Halaman Login (Instan)
    switchPage('login');
  }

  // 4. [BARU] Fungsi Monitor Aktifitas User
  function startActivityMonitor() {
    // Daftar aksi yang dianggap sebagai "User Sedang Aktif"
    var events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart'];
    
    // Hapus listener lama (jika ada) agar tidak duplikat
    events.forEach(function(e) { document.removeEventListener(e, userIsActive); });
    
    // Pasang listener baru ke dokumen
    events.forEach(function(e) { document.addEventListener(e, userIsActive); });

    // Jalankan pengecekan background setiap 1 menit
    // Ini berfungsi untuk menendang user keluar jika dia meninggalkan laptop (idle)
    if(sessionInterval) clearInterval(sessionInterval);
    sessionInterval = setInterval(checkAutoLogout, 60000); 
  }

  // Logic: User melakukan sesuatu (Gerak mouse, klik, ngetik)
  function userIsActive() {
    var now = new Date().getTime();
    
    // Throttling: Kita hanya update ke localStorage maksimal 1 menit sekali
    // Tujuannya agar browser tidak berat karena setiap gerakan mouse menulis data
    if (now - lastActivityUpdate > 60000) { 
       updateSessionExpiry();
       lastActivityUpdate = now;
    }
  }

  // Fungsi memperpanjang waktu expiry di localStorage
  function updateSessionExpiry() {
    var sessionData = localStorage.getItem('appSekolahSession');
    if (sessionData) {
       var session = JSON.parse(sessionData);
       // Reset waktu kadaluarsa menjadi: Sekarang + 1 Jam
       session.expiry = new Date().getTime() + SESSION_TIMEOUT; 
       localStorage.setItem('appSekolahSession', JSON.stringify(session));
       // console.log("Sesi diperpanjang karena user aktif.");
    }
  }

  // Logic: Cek apakah sudah waktunya logout (user diam > 1 jam)
  function checkAutoLogout() {
    var sessionData = localStorage.getItem('appSekolahSession');
    if (sessionData) {
      var session = JSON.parse(sessionData);
      var now = new Date().getTime();
      
      // Jika waktu sekarang sudah melewati batas expiry yang tersimpan
      if (now > session.expiry) {
        console.log("Sesi habis karena tidak aktif selama 1 jam.");
        logoutApp();
      }
    } else {
      // Jika data sesi tiba-tiba hilang (misal dihapus dari tab lain)
      logoutApp();
    }
  }

  // --- NAVIGATION ---
  function switchPage(page) {
    // 1. Definisikan variabel elemen
    var container = document.getElementById('authContainer'); // Pembungkus Baru
    var pLogin    = document.getElementById('loginPage');
    var pRegister = document.getElementById('registerPage');
    var pDash     = document.getElementById('dashboardPage');

    // 2. SEMBUNYIKAN SEMUANYA DULU (Reset)
    // PENTING: Sembunyikan container agar tidak menutupi dashboard
    if (container) container.style.display = 'none'; 
    if (pLogin)    pLogin.style.display = 'none';
    if (pRegister) pRegister.style.display = 'none';
    if (pDash)     pDash.style.display = 'none';

    // 3. TAMPILKAN HALAMAN YANG DIPILIH
    if (page === 'login') {
      // Jika login, kita butuh container (background) + form login
      if (container) container.style.display = 'flex'; 
      if (pLogin)    pLogin.style.display = 'block';
    } 
    else if (page === 'register') {
      // Jika register, kita butuh container (background) + form register
      if (container) container.style.display = 'flex';
      if (pRegister) pRegister.style.display = 'block';
    } 
    else if (page === 'dashboard') {
      // Jika dashboard, Container HARUS SEMBUNYI (sudah di-hide di langkah no 2)
      // Kita hanya munculkan dashboardPage
      if (pDash) {
        pDash.style.display = 'block';
        
        // Logika tambahan dashboard Anda (Modal & Settings)
        if(!modalSiswa) {
           // Pastikan elemen modal ada sebelum di-init
           var elModal = document.getElementById('studentModal');
           if(elModal) modalSiswa = new bootstrap.Modal(elModal);
        }
        
        // Cek apakah fungsi loadSettings ada sebelum dipanggil
        if (typeof loadSettings === 'function') {
           loadSettings(); 
        }
      }
    }
  }

  // --- AUTHENTICATION ---
  function runLogin() {
    var email = document.getElementById('loginEmail').value;
    var pass = document.getElementById('loginPass').value;
    var btn = document.getElementById('btnLogin');
    btn.disabled = true; btn.innerText = "Loading...";

    google.script.run.withSuccessHandler(function(res){
        btn.disabled = false; btn.innerText = "Login";
        if(res.status === 'success') {
          // [UBAH DISINI] Simpan sesi sebelum pindah halaman
          saveSession(res.token, res.sekolah);
          
          currentToken = res.token;
          document.getElementById('schoolTitle').innerText = res.sekolah;
          switchPage('dashboard');
          loadTableData(); 
        } else { showToast(res.message, 'bg-danger'); }
      }).loginSchool(email, pass);
  }

  function runRegister() {
    var form = {
      namaSekolah: document.getElementById('regSekolah').value,
      email: document.getElementById('regEmail').value,
      password: document.getElementById('regPass').value
    };
    if(!form.namaSekolah || !form.email) return showToast("Isi semua data!", 'bg-warning');

    var btn = document.getElementById('btnReg');
    btn.disabled = true; btn.innerText = "Memproses...";
    
    google.script.run.withSuccessHandler(function(res){
      btn.disabled = false; btn.innerText = "Buat Database";
      if(res.status === 'success') {
        alert(res.message); switchPage('login');
      } else { showToast(res.message, 'bg-danger'); }
    }).registerSchool(form);
  }

  // --- UPDATE FUNGSI LOAD TABLE DATA ---
  function loadTableData() {
    var tbody = document.querySelector('#studentTable tbody');
    
    // Set status loading
    isLoading = true;
    setButtonsDisabled(true); // Matikan tombol
    
    tbody.innerHTML = "<tr><td colspan='9' class='text-center'>Mengambil data...</td></tr>";

    google.script.run.withSuccessHandler(function(res){
      // Reset status loading setelah selesai (sukses/gagal)
      isLoading = false;
      setButtonsDisabled(false); // Hidupkan tombol kembali

      if(res.status === 'success') {
        studentList = res.data;
        renderTable();
        
        // Opsional: Jika user sedang membuka tab Generate Kartu, refresh tampilannya otomatis
        // agar loadingnya hilang dan kartu muncul
        var generatePane = document.getElementById('generate-pane');
        if (generatePane && generatePane.classList.contains('active')) {
             renderAllCards();
        }

      } else {
        tbody.innerHTML = "<tr><td colspan='9' class='text-danger'>Error: "+res.message+"</td></tr>";
      }
    }).getStudents(currentToken);
  }

  // [BARU] Helper untuk mematikan/menghidupkan tombol aksi
  function setButtonsDisabled(state) {
    var btnExcel = document.getElementById('btnUploadExcel');
    var btnZip = document.getElementById('btnUploadZip');
    var btnManual = document.getElementById('btnAddManual');
    
    if(btnExcel) btnExcel.disabled = state;
    if(btnZip) btnZip.disabled = state;
    if(btnManual) btnManual.disabled = state;
  }

  function renderTable() {
    var tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = "";
    
    document.getElementById('checkAll').checked = false;
    updateSelectionUI(); 

    if(studentList.length === 0) {
      tbody.innerHTML = "<tr><td colspan='9' class='text-center'>Belum ada data siswa.</td></tr>";
      return;
    }

    studentList.forEach((s, index) => {
      var btnEdit = `<button class="btn btn-warning btn-sm me-1" onclick="openModalEdit(${index})"><i class="bi bi-pencil"></i></button>`;
      var btnDel  = `<button class="btn btn-outline-danger btn-sm" onclick="deleteData(${index})"><i class="bi bi-trash"></i></button>`;
      
      // GANTI BAGIAN VARIABEL 'img' MENJADI SEPERTI INI:
      var img = (s.foto && s.foto.length > 20) 
        ? `<img src="${s.foto}" width="50" height="60" 
               class="border rounded thumb-clickable" 
               style="object-fit:cover; background:#eee;" 
               onclick="openPhotoPreview('${s.foto}')" 
               onerror="this.onerror=null;this.src='https://via.placeholder.com/50?text=Err';">` 
        : '<span class="text-muted">-</span>';
      
      // --- PERUBAHAN DISINI (FORMAT TTL) ---
      // Kita format s.tgl_lahir menggunakan fungsi helper baru
      var tglCantik = formatTanggalIndo(s.tgl_lahir); 
      var ttl = `${s.tmp_lahir}, ${tglCantik}`;
      // -------------------------------------

      var row = `<tr>
        <td class="text-center align-middle">
           <input type="checkbox" class="form-check-input row-check" value="${index}" onclick="updateSelectionUI()">
        </td>
        <td class="text-center align-middle">${index+1}</td>
        <td class="text-center align-middle">${btnEdit}${btnDel}</td>
        
        <td class="fw-bold align-middle">${s.nama}</td>
        <td class="text-center align-middle">${s.nisn}</td>
        
        <td class="align-middle">${ttl}</td>
        
        <td class="text-center align-middle">${s.jk}</td>
        <td class="align-middle">${s.alamat}</td>
        <td class="text-center align-middle">${img}</td>
      </tr>`;
      tbody.innerHTML += row;
    });
  }

  // --- CRUD MODAL OPERATIONS ---
  
  // Fungsi Preview Gambar saat user memilih file
  function previewImage(input) {
    var preview = document.getElementById('imgPreview');
    var txt = document.getElementById('txtNoFoto');
    
    if (input.files && input.files[0]) {
      var reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        txt.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    } else {
      // Jika batal pilih, kembalikan ke kondisi sebelumnya (jika ada foto lama)
      var old = document.getElementById('inpFotoOld').value;
      if(old) {
        preview.src = old;
        preview.style.display = 'block';
        txt.style.display = 'none';
      } else {
        preview.style.display = 'none';
        txt.style.display = 'block';
      }
    }
  }

  function openModalAdd() {
    document.getElementById('modalTitle').innerText = "Tambah Siswa";
    document.getElementById('editRow').value = ""; 
    
    document.getElementById('inpNama').value = "";
    document.getElementById('inpNISN').value = "";
    document.getElementById('inpTmpLahir').value = "";
    document.getElementById('inpTglLahir').value = "";
    document.getElementById('inpJK').value = "L";
    document.getElementById('inpKelas').value = "";
    document.getElementById('inpAlamat').value = "";
    
    // Reset Foto
    document.getElementById('inpFotoFile').value = "";
    document.getElementById('inpFotoOld').value = "";
    document.getElementById('imgPreview').style.display = 'none';
    document.getElementById('txtNoFoto').style.display = 'block';
    
    modalSiswa.show();
  }

  function openModalEdit(index) {
    var s = studentList[index];
    document.getElementById('modalTitle').innerText = "Edit Siswa";
    document.getElementById('editRow').value = s.row;
    
    document.getElementById('inpNama').value = s.nama;
    document.getElementById('inpNISN').value = s.nisn;
    document.getElementById('inpTmpLahir').value = s.tmp_lahir;
    document.getElementById('inpTglLahir').value = s.tgl_lahir;
    document.getElementById('inpJK').value = s.jk;
    document.getElementById('inpKelas').value = s.kelas;
    document.getElementById('inpAlamat').value = s.alamat;
    
    // Set Foto Lama
    document.getElementById('inpFotoFile').value = ""; // Reset input file
    document.getElementById('inpFotoOld').value = s.foto;
    
    if(s.foto && s.foto.length > 5) {
      document.getElementById('imgPreview').src = s.foto;
      document.getElementById('imgPreview').style.display = 'block';
      document.getElementById('txtNoFoto').style.display = 'none';
    } else {
      document.getElementById('imgPreview').style.display = 'none';
      document.getElementById('txtNoFoto').style.display = 'block';
    }
    
    modalSiswa.show();
  }

  function saveStudent() {
    var fileInput = document.getElementById('inpFotoFile');
    var file = fileInput.files[0];

    // Ambil nilai text form dulu
    var data = {
      row: document.getElementById('editRow').value,
      nama: document.getElementById('inpNama').value,
      nisn: document.getElementById('inpNISN').value,
      tmp_lahir: document.getElementById('inpTmpLahir').value,
      tgl_lahir: document.getElementById('inpTglLahir').value,
      jk: document.getElementById('inpJK').value,
      kelas: document.getElementById('inpKelas').value,
      alamat: document.getElementById('inpAlamat').value,
      foto: document.getElementById('inpFotoOld').value // Default pakai foto lama
    };

    if(!data.nama) return alert("Nama wajib diisi");
    
    // UI Loading
    var btn = document.getElementById('btnSimpanSiswa');
    var oriText = btn.innerText;
    btn.disabled = true; 
    btn.innerText = "Mengupload...";

    // Helper untuk kirim ke backend
    var sendToBackend = function(finalData) {
      var handler = function(res) {
        btn.disabled = false; btn.innerText = oriText;
        if(res.status === 'success') {
          showToast(res.message, 'bg-success');
          modalSiswa.hide();
          loadTableData(); 
        } else {
          alert(res.message);
        }
      };

      if(finalData.row === "") {
        google.script.run.withSuccessHandler(handler).addStudent(currentToken, finalData);
      } else {
        google.script.run.withSuccessHandler(handler).editStudent(currentToken, finalData);
      }
    };

    // Cek apakah user upload file baru?
    if (file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        // Ganti properti foto dengan data base64 gambar baru
        data.foto = e.target.result; 
        sendToBackend(data);
      };
      reader.readAsDataURL(file);
    } else {
      // Tidak ada file baru, kirim data apa adanya (pakai foto lama/kosong)
      sendToBackend(data);
    }
  }

  function deleteData(index) {
    if(!confirm("Hapus siswa " + studentList[index].nama + "?")) return;
    
    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success') {
        showToast("Terhapus.", 'bg-success');
        loadTableData();
      } else {
        alert(res.message);
      }
    }).deleteStudent(currentToken, studentList[index].row);
  }

  // --- CONFIGURATION FUNCTIONS (BARU) ---

  // 1. Ambil nilai dari Form
  function getConfigs() {
    return {
      yayasan: document.getElementById('confYayasan').value,
      alamat1: document.getElementById('confAlamat1').value,
      alamat2: document.getElementById('confAlamat2').value,
      telp: document.getElementById('confTelp').value,    // Baru
      email: document.getElementById('confEmail').value,  // Baru
      tgl: document.getElementById('confTgl').value,
      kepala: document.getElementById('confKepala').value,
      nip: document.getElementById('confNIP').value,
      logoKiri: document.getElementById('confLogoKiri').value,
      logoKanan: document.getElementById('confLogoKanan').value,
      stempel: document.getElementById('confStempel').value,
      ttd: document.getElementById('confTTD').value,
    };
  }

  // 2. Fungsi Simpan ke Server
  function runSaveSettings() {
    var conf = getConfigs();
    var btn = document.getElementById('btnSaveConfig');
    var txt = btn.innerHTML;
    
    btn.disabled = true; btn.innerText = "Menyimpan...";

    google.script.run.withSuccessHandler(function(res){
      btn.disabled = false; btn.innerHTML = txt;
      if(res.status === 'success') {
        showToast(res.message, 'bg-success');
      } else {
        showToast(res.message, 'bg-danger');
      }
    }).saveSchoolConfig(currentToken, conf);
  }

  // 3. Fungsi Load dari Server
  function loadSettings() {
    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success' && res.data) {
        var d = res.data;
        // Isi form jika datanya ada di database
        if(d.yayasan) document.getElementById('confYayasan').value = d.yayasan;
        if(d.alamat1) document.getElementById('confAlamat1').value = d.alamat1;
        if(d.alamat2) document.getElementById('confAlamat2').value = d.alamat2;
        if(d.telp) document.getElementById('confTelp').value = d.telp;
        if(d.email) document.getElementById('confEmail').value = d.email;
        if(d.tgl) document.getElementById('confTgl').value = d.tgl;
        if(d.kepala) document.getElementById('confKepala').value = d.kepala;
        if(d.nip) document.getElementById('confNIP').value = d.nip;
        if(d.logoKiri) document.getElementById('confLogoKiri').value = d.logoKiri;
        if(d.logoKanan) document.getElementById('confLogoKanan').value = d.logoKanan;
        if(d.stempel) document.getElementById('confStempel').value = d.stempel;
        if(d.ttd) document.getElementById('confTTD').value = d.ttd;
        
        // Render ulang preview setelah data masuk
        renderPreview();
      }
    }).getSchoolConfig(currentToken);
  }

  // 4. Update Tampilan Kartu Belakang (Preview)
  function createBackCardHTML(conf) {
    var sekolah = document.getElementById('schoolTitle').innerText || "MADRASAH CONTOH";
    var sekolahUpper = sekolah.toUpperCase(); 

    var yayasan = conf.yayasan || "";
    var alamat1 = conf.alamat1 || "";
    var alamat2 = conf.alamat2 || "";
    var kontakHP = conf.telp ? conf.telp : '-';
    var email = conf.email || "-"; // Default dash jika kosong
    var logoKiri = conf.logoKiri;
    var logoKanan = conf.logoKanan;

    return `
      <div class="back-card">
        <div class="back-header-flat">
           <div class="back-logo-box"><img src="${logoKiri}" onerror="this.style.display='none'"></div>
           <div class="back-header-text">
             <div class="txt-yayasan">${yayasan}</div>
             <div class="txt-sekolah">${sekolahUpper}</div>
             <div class="txt-alamat">${alamat1}<br>${alamat2}</div>
           </div>
           <div class="back-logo-box"><img src="${logoKanan}" onerror="this.style.display='none'"></div>
        </div>

        <div class="back-body">
          <div>
            <div class="rules-title">TATA TERTIB PENGGUNAAN KARTU</div>
            
            <ol class="rules-list" style="text-align: justify; padding-right: 10px;">
              <li>Kartu ini berlaku sebagai Identitas Siswa & Anggota Perpustakaan selama aktif di <strong>${sekolahUpper}</strong>.</li>
              <li>Siswa/Anggota wajib mematuhi segala Peraturan Tata Tertib Madrasah & Perpustakaan.</li>
              <li>Siswa bertanggung jawab penuh atas penggunaan dan pemeliharaan kartu ini.</li>
              <li>Madrasah berhak mencabut status kesiswaan/keanggotaan jika terbukti melanggar tata tertib.</li>
              <li>Apabila kartu hilang/ditemukan, harap segera melapor ke Bagian Kesiswaan/Perpustakaan.</li>
            </ol>
          </div>

          <div class="back-footer-container">
            <div class="cp-title">Contact Person:</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 8px; font-weight: bold; margin-top: 3px; border-top: 1px dotted #ccc; padding-top: 2px;">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <span>Telp :</span> <span>${kontakHP}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <span>Email :</span> <span>${email}</span>
                </div>
            </div>

          </div>

        </div>
      </div>
    `;
  }

  // --- UPDATE FUNGSI CREATE CARD HTML ---
  function createCardHTML(s, conf) {
    var ttl = `${s.tmp_lahir}, ${s.tgl_lahir}`;
    var sekolah = document.getElementById('schoolTitle').innerText;

    // 1. Logic Cek Foto
    // Cek apakah string foto valid (panjang > 20 dan mengandung 'http')
    var hasPhoto = (s.foto && s.foto.length > 20 && s.foto.includes('http'));
    
    // Jika ada foto, buat tag IMG dengan class 'real-photo'
    // Jika tidak ada, kosongkan string ini.
    var photoImgHtml = hasPhoto ? `<img src="${s.foto}" class="real-photo">` : '';

    // Logic TTD & Stempel (Tetap sama)
    var ttdHtml = conf.ttd ? `<img src="${conf.ttd}" class="sig-img">` : `<div class="sig-placeholder"></div>`;
    var stempelHtml = conf.stempel ? `<img src="${conf.stempel}" class="stamp-img">` : ``;

    return `
      <div class="id-card temp-madrasah">
        <div class="madrasah-header">
          <div class="logo-box"><img src="${conf.logoKiri}" onerror="this.style.display='none'"></div>
          <div class="header-text">
            <div class="txt-yayasan">${conf.yayasan}</div>
            <div class="txt-sekolah">${sekolah}</div>
            <div class="txt-alamat">${conf.alamat1}<br>${conf.alamat2}</div>
          </div>
          <div class="logo-box"><img src="${conf.logoKanan}" onerror="this.style.display='none'"></div>
        </div>
        <div class="card-title-bar">KARTU PELAJAR</div>
        <div class="card-body-custom">
          
          <div class="photo-area">
             <i class="bi bi-person-fill ph-icon"></i>
             <div class="ph-text">3 X 4</div>
             
             ${photoImgHtml}
          </div>
          <div class="right-panel">
            <div class="data-area">
              <table>
                <tr><td>Nama</td><td>:</td><td><strong>${s.nama}</strong></td></tr>
                <tr><td>NISN</td><td>:</td><td>${s.nisn}</td></tr>
                <tr><td>TTL</td><td>:</td><td>${ttl}</td></tr>
                <tr><td>L/P</td><td>:</td><td>${s.jk}</td></tr>
                <tr><td>Alamat</td><td>:</td><td>${s.alamat}</td></tr>
              </table>
            </div>
            <div class="signature-area">
              ${stempelHtml}
              <div style="position:relative; z-index:2">
                <div>${conf.tgl}</div>
                <div>Kepala Madrasah,</div>
                ${ttdHtml}
                <div class="head-name">${conf.kepala}</div>
                <div class="head-nip">NIP. ${conf.nip}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // --- FUNGSI RENDER PREVIEW (SMART FADE - NO BLUR) ---
  function renderPreview() {
    var dummy = { 
      nama: "PREVIEW SISWA", nisn: "0012345678", 
      tmp_lahir: "Jakarta", tgl_lahir: "2010-01-01", 
      jk: "L", kelas: "X-A", 
      alamat: "Jl. Contoh No. 1", foto: "" 
    };
    var conf = getConfigs();

    var htmlDepan = createCardHTML(dummy, conf);
    var htmlBelakang = createBackCardHTML(conf);

    // Cek Container
    var switcher = document.getElementById('cardSwitcher');
    
    if (!switcher) {
      // Struktur HTML Baru (Switch Container)
      document.getElementById('previewContainer').innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center p-3">
          
          <div class="switch-container" id="cardSwitcher" onclick="toggleSwitchCard()">
            <div class="switch-face face-front" id="viewDepan">
               ${htmlDepan}
            </div>
            <div class="switch-face face-back" id="viewBelakang">
               ${htmlBelakang}
            </div>
          </div>

          <div class="mt-4 text-center text-muted small user-select-none">
              <i class="bi bi-arrow-repeat"></i> Klik kartu untuk melihat sisi belakang
          </div>

        </div>
      `;
      switcher = document.getElementById('cardSwitcher');
    } else {
      // Update isi jika container sudah ada
      document.getElementById('viewDepan').innerHTML = htmlDepan;
      document.getElementById('viewBelakang').innerHTML = htmlBelakang;
    }

    // Logic Otomatis (Cek Input User)
    var activeEl = document.activeElement;
    if (activeEl && activeEl.id) {
      // Jika ngetik HP/Email -> Tampilkan Belakang (tambah class show-back)
      if (activeEl.id === 'confTelp' || activeEl.id === 'confEmail') {
         switcher.classList.add('show-back');
      } 
      // Jika ngetik Config lain -> Tampilkan Depan (hapus class show-back)
      else if (activeEl.id.startsWith('conf')) {
         switcher.classList.remove('show-back');
      }
    }
  }

  // Fungsi Toggle Manual
  function toggleSwitchCard() {
    var switcher = document.getElementById('cardSwitcher');
    if(switcher) switcher.classList.toggle('show-back');
  }

  // --- FUNGSI TOGGLE KLIK KARTU ---
  function togglePreview(element) {
    var depan = document.getElementById('viewDepan');
    var belakang = document.getElementById('viewBelakang');
    
    // 1. Efek visual 'Tekan' (mengecil sedikit saat diklik)
    element.style.transform = "scale(0.95)";
    
    setTimeout(function() {
      // 2. Logic Tukar Tampilan
      if (depan.style.display !== 'none') {
        depan.style.display = 'none';
        belakang.style.display = 'block';
      } else {
        depan.style.display = 'block';
        belakang.style.display = 'none';
      }
      
      // 3. Kembalikan ukuran normal
      element.style.transform = "scale(1)";
    }, 150); // Delay sedikit agar efek tekan terasa
  }

  // --- [UPDATE] FUNGSI RENDER ALL CARDS DENGAN PILIHAN TEMPLATE ---
  function renderAllCards() {
    var container = document.getElementById('cardContainer');
    container.innerHTML = "";
    container.className = "d-flex flex-column align-items-center w-100";
    
    if (isLoading) {
      container.innerHTML = `<div class="alert alert-info">Sedang memuat data...</div>`;
      return;
    }
    if(studentList.length === 0) {
      container.innerHTML = "<div class='alert alert-warning'>Belum ada data siswa.</div>";
      return;
    }

    var conf = getConfigs();
    
    // AMBIL NILAI DARI DROPDOWN (Default 1)
    var styleMode = document.getElementById('printTemplateMode').value || "1";
    
    var html = "";
    studentList.forEach(s => {
      html += `<div class="view-card-wrapper">`;
      html += `<div class="print-row">`;
          // Panggil fungsi Generator Template Baru
          html += getCardTemplate('front', styleMode, s, conf);
          html += getCardTemplate('back', styleMode, s, conf);
      html += `</div>`;
      html += `</div>`; 
    });

    container.innerHTML = html;
  }

  // --- [BARU] TEMPLATE ENGINE UTAMA ---
  // Fungsi ini mengatur HTML berdasarkan ID Style yang dipilih
  function getCardTemplate(type, styleId, s, conf) {
    // Persiapan Data Umum
    var sekolahRaw = document.getElementById('schoolTitle').innerText || "NAMA SEKOLAH";
    // [UPDATE] Paksa Kapital untuk tampilan belakang
    var sekolahUpper = sekolahRaw.toUpperCase(); 
    
    // Untuk depan, biarkan sesuai input atau kapital juga (opsional, disini saya buat default input)
    // Jika ingin depan juga kapital semua, ganti sekolahRaw jadi sekolahUpper di bagian 'front'
    var sekolah = sekolahRaw; 

    var hasPhoto = (s && s.foto && s.foto.length > 20 && s.foto.includes('http'));
    var photoHtml = hasPhoto ? `<img src="${s.foto}" class="real-photo">` : '';
    
    // TTD & Stempel
    var ttdHtml = conf.ttd ? `<img src="${conf.ttd}" class="sig-img">` : `<div class="sig-placeholder"></div>`;
    var stempelHtml = conf.stempel ? `<img src="${conf.stempel}" class="stamp-img">` : ``;

    // Data Teks
    var ttl = s ? `${s.tmp_lahir}, ${s.tgl_lahir}` : "";
    var kontak = conf.telp || "-";
    
    // --- MODE 1: MADRASAH (DEFAULT LAMA) ---
    if (styleId === "1") {
      if (type === 'front') {
         return `
        <div class="id-card temp-madrasah style-1">
          <div class="madrasah-header">
            <div class="logo-box"><img src="${conf.logoKiri}" onerror="this.style.display='none'"></div>
            <div class="header-text">
              <div class="txt-yayasan">${conf.yayasan}</div>
              <div class="txt-sekolah">${sekolah}</div>
              <div class="txt-alamat">${conf.alamat1}<br>${conf.alamat2}</div>
            </div>
            <div class="logo-box"><img src="${conf.logoKanan}" onerror="this.style.display='none'"></div>
          </div>
          <div class="card-title-bar">KARTU PELAJAR</div>
          <div class="card-body-custom">
            <div class="photo-area">
               <i class="bi bi-person-fill ph-icon"></i><div class="ph-text">3 X 4</div>
               ${photoHtml}
            </div>
            <div class="right-panel">
              <div class="data-area">
                <table>
                  <tr><td>Nama</td><td>:</td><td><strong>${s.nama}</strong></td></tr>
                  <tr><td>NISN</td><td>:</td><td>${s.nisn}</td></tr>
                  <tr><td>TTL</td><td>:</td><td>${ttl}</td></tr>
                  <tr><td>L/P</td><td>:</td><td>${s.jk}</td></tr>
                  <tr><td>Alamat</td><td>:</td><td>${s.alamat}</td></tr>
                </table>
              </div>
              <div class="signature-area">
                ${stempelHtml}
                <div style="position:relative; z-index:2">
                  <div>${conf.tgl}</div>
                  <div>Kepala Madrasah,</div>
                  ${ttdHtml}
                  <div class="head-name">${conf.kepala}</div>
                  <div class="head-nip">NIP. ${conf.nip}</div>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      } else {
        // [UPDATE] BAGIAN BELAKANG MODE 1 (PRINT)
        return `
        <div class="back-card style-1">
          <div class="back-header-flat">
             <div class="back-logo-box"><img src="${conf.logoKiri}" onerror="this.style.display='none'"></div>
             <div class="back-header-text">
               <div class="txt-yayasan">${conf.yayasan}</div>
               <div class="txt-sekolah">${sekolahUpper}</div>
               <div class="txt-alamat">${conf.alamat1}<br>${conf.alamat2}</div>
             </div>
             <div class="back-logo-box"><img src="${conf.logoKanan}" onerror="this.style.display='none'"></div>
          </div>
          <div class="back-body">
            <div>
              <div class="rules-title">TATA TERTIB PENGGUNAAN KARTU</div>
              
              <ol class="rules-list" style="text-align: justify; padding-right: 10px;">
                <li>Kartu ini berlaku sebagai Identitas Siswa & Anggota Perpustakaan selama aktif di <strong>${sekolahUpper}</strong>.</li>
                <li>Siswa/Anggota wajib mematuhi segala Peraturan Tata Tertib Madrasah & Perpustakaan.</li>
                <li>Siswa bertanggung jawab penuh atas penggunaan dan pemeliharaan kartu ini.</li>
                <li>Madrasah berhak mencabut status kesiswaan/keanggotaan jika terbukti melanggar tata tertib.</li>
                <li>Apabila kartu hilang/ditemukan, harap segera melapor ke Bagian Kesiswaan/Perpustakaan.</li>
              </ol>
            </div>

            <div class="back-footer-container">
              <div class="cp-title">Contact Person:</div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; font-size: 8px; font-weight: bold; margin-top: 3px; border-top: 1px dotted #ccc; padding-top: 2px;">
                  <div style="display: flex; align-items: center; gap: 4px;">
                      <span>Telp :</span> <span>${kontak}</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 4px;">
                      <span>Email :</span> <span>${conf.email || '-'}</span>
                  </div>
              </div>
            </div>

          </div>
        </div>`;
      }
    }
    
    // --- MODE 2 s/d 11 (TEMPLATE GENERIK) ---
    var themeClass = "style-" + styleId; 

    if (type === 'front') {
        return `
        <div class="id-card temp-generic ${themeClass}">
            <div class="gen-header">
                <img src="${conf.logoKiri}" class="logo-sm left">
                <div class="gen-header-text">
                    <div class="gen-yayasan">${conf.yayasan}</div>
                    <div class="gen-sekolah">${sekolah}</div>
                    <div class="gen-alamat">${conf.alamat1} ${conf.alamat2 ? '<br>' + conf.alamat2 : ''}</div>
                </div>
                <img src="${conf.logoKanan}" class="logo-sm right">
            </div>

            <div class="gen-body">
                <div class="gen-photo-box">
                    <div class="gen-photo-placeholder">FOTO</div>
                    ${photoHtml}
                </div>
                
                <div class="gen-data-box">
                    <div class="gen-card-title">KARTU TANDA PELAJAR</div>
                    <table class="gen-table">
                        <tr><td width="50">Nama</td><td width="5">:</td><td class="fw-bold">${s.nama}</td></tr>
                        <tr><td>NISN</td><td>:</td><td>${s.nisn}</td></tr>
                        <tr><td>TTL</td><td>:</td><td>${ttl}</td></tr>
                        <tr><td>Gender</td><td>:</td><td>${s.jk === 'L' ? 'Laki-laki' : 'Perempuan'}</td></tr>
                        <tr><td>Alamat</td><td>:</td><td class="alamat-cut">${s.alamat}</td></tr>
                    </table>
                </div>
            </div>

            <div class="gen-footer">
                <div class="gen-ttd-box">
                    ${stempelHtml}
                    <div class="ttd-date">${conf.tgl}</div>
                    <div class="ttd-jabatan">Kepala Sekolah</div>
                    <div class="ttd-sign-wrap">${ttdHtml}</div>
                    <div class="ttd-name">${conf.kepala}</div>
                    <div class="ttd-nip">NIP. ${conf.nip}</div>
                </div>
            </div>
            
            <div class="decoration-bar"></div>
        </div>
        `;
    } else {
        // --- TAMPILAN BELAKANG (GENERIK) ---
        return `
        <div class="back-card temp-generic-back ${themeClass}">
            <div class="gen-header back-h">
                 <img src="${conf.logoKiri}" class="logo-sm left" onerror="this.style.display='none'">
                 
                 <div class="gen-header-text text-center">
                    <div class="gen-yayasan small">${conf.yayasan}</div>
                    
                    <div class="gen-sekolah small">${sekolahUpper}</div> <div class="gen-alamat small">${conf.alamat1} ${conf.alamat2 ? '<br>' + conf.alamat2 : ''}</div>
                 </div>

                 <img src="${conf.logoKanan}" class="logo-sm right" onerror="this.style.display='none'">
            </div>
            
            <div class="back-content p-3">
                <div class="rules-box">
                    <div class="rules-head">TATA TERTIB PENGGUNAAN KARTU</div>
                    <ol>
                        <li>Kartu ini adalah kartu identitas resmi siswa <b>${sekolahUpper}</b>.</li> <li>Harap membawa kartu ini selama berada di lingkungan sekolah.</li>
                        <li>Dilarang mencoret atau merusak kartu.</li>
                        <li>Jika menemukan kartu ini, mohon kembalikan ke alamat sekolah.</li>
                    </ol>
                </div>
                
                <div class="contact-box mt-3">
                   <div class="cp-head">INFO KONTAK</div>
                   <div>Telp: ${kontak}</div>
                   <div>Email: ${conf.email}</div>
                </div>
                
                </div>
        </div>
        `;
    }
  }

  // --- UTILS ---
  function showToast(msg, bgClass) {
    var el = document.getElementById('toastNotif');
    el.className = `toast align-items-center text-white border-0 ${bgClass}`;
    document.getElementById('toastMsg').innerText = msg;
    new bootstrap.Toast(el).show();
  }

  // --- FITUR IMPORT & EXPORT EXCEL (VERSI PRO) ---

  // 1. Download Template Excel (Format Text & Auto Width)
  function downloadTemplateExcel() {
    // Data Header & Dummy
    // Perhatikan: NISN diberi tanda petik satu (') di depan pada data dummy
    // agar user paham itu harus teks.
    var data = [
      ["Nama", "NISN", "TempatLahir", "TglLahir", "JK", "Kelas", "Alamat"], 
      ["Siswa Contoh", "0012345678", "Jakarta", "2010-01-31", "L", "X-A", "Jl. Mawar No 1"]
    ];

    // Buat Workbook & Worksheet
    var wb = XLSX.utils.book_new();
    var ws = XLSX.utils.aoa_to_sheet(data);

    // --- FORMATTING KOLOM ---
    // Kita atur lebar kolom agar rapi
    var wscols = [
      {wch: 25}, // A: Nama
      {wch: 15}, // B: NISN
      {wch: 15}, // C: TmpLahir
      {wch: 15}, // D: TglLahir
      {wch: 5},  // E: JK
      {wch: 10}, // F: Kelas
      {wch: 30}  // G: Alamat
    ];
    ws['!cols'] = wscols;

    // --- PAKSA FORMAT TEXT (PENTING!) ---
    // Kita loop semua sel yang ada datanya untuk memastikan formatnya Text (@)
    // Range deteksi otomatis dari data
    var range = XLSX.utils.decode_range(ws['!ref']);
    
    for (var R = 0; R <= range.e.r; ++R) {
      for (var C = 0; C <= range.e.c; ++C) {
        var cellAddress = {c: C, r: R};
        var cellRef = XLSX.utils.encode_cell(cellAddress);
        
        if (!ws[cellRef]) continue;

        // Kolom B (NISN, index 1) & D (TglLahir, index 3) -> PAKSA TEXT
        if (C === 1 || C === 3) {
          ws[cellRef].z = '@';   // Format cell Excel jadi "Text"
          ws[cellRef].t = 's';   // Tipe data library jadi "String"
        }
      }
    }

    XLSX.utils.book_append_sheet(wb, ws, "TemplateSiswa");
    XLSX.writeFile(wb, "Template_Data_Siswa.xlsx");
  }

  // 2. Helper: Konversi Serial Date Excel ke YYYY-MM-DD
  function excelDateToJSDate(serial) {
    // Jika input sudah string (misal: "2023-01-01"), kembalikan langsung
    if (typeof serial === 'string' || serial instanceof String) return serial;
    
    // Jika kosong/null
    if (!serial) return "";

    // Rumus konversi hari Excel ke JS Date
    // Excel mulai dari 30 Des 1899 (biasanya), JS 1 Jan 1970
    var utc_days  = Math.floor(serial - 25569);
    var utc_value = utc_days * 86400;                                 
    var date_info = new Date(utc_value * 1000);

    // Format ke YYYY-MM-DD
    // Perlu penyesuaian timezone sedikit karena pembulatan, tapi biasanya aman
    // Kita ambil bagian YMD nya saja secara manual agar tidak kena geser jam
    var year = date_info.getFullYear();
    var month = ("0" + (date_info.getMonth() + 1)).slice(-2);
    var day = ("0" + date_info.getDate()).slice(-2);

    return `${year}-${month}-${day}`;
  }

  // 3. Proses Upload Excel (Smart Reading)
  function processImportExcel(input) {
    var file = input.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
      var data = new Uint8Array(e.target.result);
      var workbook = XLSX.read(data, {type: 'array'});
      var firstSheet = workbook.Sheets[workbook.SheetNames[0]];

      // Ambil data JSON mentah (termasuk format aslinya)
      var jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, raw: true});

      parseAndUploadExcel(jsonData);
    };
    reader.readAsArrayBuffer(file);
    input.value = ""; 
  }

  // 4. Parsing Data & Kirim
  function parseAndUploadExcel(rows) {
    // Hapus header
    if (rows.length > 0) rows.shift();

    var dataUpload = [];
    
    rows.forEach(function(row) {
      // Validasi baris: Minimal kolom Nama (index 0) terisi
      if (row.length > 0 && row[0]) {
        
        // --- LOGIKA NISN (Pastikan jadi String) ---
        var rawNISN = row[1] ? row[1].toString().trim() : "";
        // Bersihkan karakter aneh jika ada (misal tanda petik sisa copy paste)
        rawNISN = rawNISN.replace(/^'|'$/g, '');

        // --- LOGIKA TANGGAL LAHIR (Smart Convert) ---
        var rawTgl = row[3];
        var finalTgl = "";

        // Cek apakah Excel mengirim Angka (Serial Date) atau Teks
        if (typeof rawTgl === 'number') {
          // Jika angka (misal 44567), convert ke YYYY-MM-DD
          finalTgl = excelDateToJSDate(rawTgl);
        } else if (typeof rawTgl === 'string') {
          // Jika teks, ambil apa adanya (asumsi user tulis YYYY-MM-DD)
          finalTgl = rawTgl.trim();
        }

        var obj = {
          nama: row[0].toString().trim(),
          nisn: rawNISN,
          tmp_lahir: row[2] ? row[2].toString().trim() : "",
          tgl_lahir: finalTgl, // Hasil konversi pintar
          jk: row[4] ? row[4].toString().trim() : "",
          kelas: row[5] ? row[5].toString().trim() : "",
          alamat: row[6] ? row[6].toString().trim() : ""
        };
        dataUpload.push(obj);
      }
    });

    if (dataUpload.length === 0) {
      alert("Data kosong atau format tidak terbaca!");
      return;
    }

    if(!confirm("Akan mengimport " + dataUpload.length + " data siswa. Lanjutkan?")) return;

    // UI Loading
    var tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Mengupload & Memproses Data...</td></tr>";

    // Kirim ke Backend
    google.script.run.withSuccessHandler(function(res){
      if(res.status === 'success') {
        alert(res.message);
        loadTableData();
      } else {
        alert("Gagal: " + res.message);
        loadTableData();
      }
    }).importBulkStudents(currentToken, dataUpload);
  }

  // --- FITUR BULK UPLOAD FOTO (ZIP) ---
  // --- LOGIC MODAL PANDUAN FOTO ---

  var modalGuide; // Variabel global untuk modal

  function showPhotoGuide() {
    // Inisialisasi modal jika belum ada
    if (!modalGuide) {
      modalGuide = new bootstrap.Modal(document.getElementById('modalPhotoGuide'));
    }
    modalGuide.show();
  }

  function proceedPhotoUpload() {
    // 1. Sembunyikan Modal
    if (modalGuide) modalGuide.hide();
    
    // 2. Klik Input File yang tersembunyi secara otomatis
    setTimeout(function() {
      document.getElementById('filePhotoZip').click();
    }, 300); // Delay sedikit agar animasi modal selesai
  }

  function uploadPhotoZip(input) {
    var file = input.files[0];
    if (!file) return;

    // Validasi
    if (file.type.indexOf('zip') === -1 && !file.name.endsWith('.zip')) {
      alert("Harap upload file format .ZIP");
      input.value = "";
      return;
    }

    // Konfirmasi
    if(!confirm("Pastikan nama file foto di dalam ZIP sesuai dengan NISN siswa (Contoh: 12345678.jpg).\nLanjutkan upload?")) return;

    var btn = input.previousElementSibling; // Tombol triggernya
    var oriText = btn.innerHTML;
    btn.disabled = true; 
    btn.innerHTML = "<i class='bi bi-hourglass-split'></i> Mengupload...";
    
    // Tampilkan loading di tabel agar terlihat prosesnya
    var tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = "<tr><td colspan='8' class='text-center'>Sedang mengekstrak & mencocokkan foto... (Bisa memakan waktu)</td></tr>";

    // Baca File sebagai Base64
    var reader = new FileReader();
    reader.onload = function(e) {
      var base64Data = e.target.result.split(',')[1]; // Ambil datanya saja tanpa header data:application/zip...
      
      // Kirim ke Server
      google.script.run.withSuccessHandler(function(res){
        btn.disabled = false; btn.innerHTML = oriText;
        input.value = ""; // Reset
        
        if(res.status === 'success') {
          alert(res.message);
          loadTableData(); // Refresh tabel untuk melihat foto baru
        } else {
          alert("Gagal: " + res.message);
          loadTableData();
        }
      }).processBulkPhotos(currentToken, base64Data);
    };
    
    reader.readAsDataURL(file);
  }

  // --- LOGIC MODAL PANDUAN EXCEL ---
  var modalExcel; // Variabel global

  function showExcelGuide() {
    if (!modalExcel) {
      modalExcel = new bootstrap.Modal(document.getElementById('modalExcelGuide'));
    }
    modalExcel.show();
  }

  function proceedExcelUpload() {
    // 1. Tutup Modal
    if (modalExcel) modalExcel.hide();
    
    // 2. Klik Input File Excel yang tersembunyi
    setTimeout(function() {
      document.getElementById('fileImportExcel').click();
    }, 300);
  }

  // --- LOGIKA HAPUS MASSAL (BULK DELETE) ---

  // 1. Fungsi Klik "Pilih Semua"
  function toggleCheckAll(source) {
    var checkboxes = document.querySelectorAll('.row-check');
    for(var i=0; i<checkboxes.length; i++) {
      checkboxes[i].checked = source.checked;
    }
    updateSelectionUI();
  }

  // 2. Update UI Pop-up (Hitung yang dipilih)
  function updateSelectionUI() {
    var selected = document.querySelectorAll('.row-check:checked');
    var count = selected.length;
    var floatBar = document.getElementById('floatingAction');
    
    document.getElementById('selectedCount').innerText = count;

    if (count > 0) {
      floatBar.classList.add('show');
    } else {
      floatBar.classList.remove('show');
      // Uncheck header jika tidak ada yang dipilih
      document.getElementById('checkAll').checked = false;
    }
  }

  // 3. Eksekusi Hapus Massal
  function runBulkDelete() {
    var selected = document.querySelectorAll('.row-check:checked');
    if (selected.length === 0) return;

    if (!confirm("Yakin ingin menghapus " + selected.length + " data siswa yang dipilih?")) return;

    // Ambil Nomor Baris (Row Excel) dari data studentList
    // Kita ambil value (index array), lalu cari properti .row di studentList
    var rowsToDelete = [];
    selected.forEach(function(cb) {
      var idx = parseInt(cb.value);
      var rowExcel = studentList[idx].row; // Mengambil nomor baris asli di Sheet
      rowsToDelete.push(rowExcel);
    });

    // UI Loading di Tombol
    var btn = document.querySelector('#floatingAction button');
    var oriText = btn.innerHTML;
    btn.disabled = true; 
    btn.innerHTML = "Processing...";

    google.script.run.withSuccessHandler(function(res){
      btn.disabled = false; btn.innerHTML = oriText;
      
      if(res.status === 'success') {
        showToast(res.message, 'bg-success');
        // Sembunyikan pop-up
        document.getElementById('floatingAction').classList.remove('show');
        // Refresh Tabel
        loadTableData();
      } else {
        alert(res.message);
      }
    }).deleteBulkStudents(currentToken, rowsToDelete);
  }

  // --- HELPER: FORMAT TANGGAL INDONESIA ---
  function formatTanggalIndo(dateString) {
    // Input: "2023-06-19" (YYYY-MM-DD)
    if (!dateString || dateString.length < 10) return dateString;

    var namaBulan = [
      '', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
      'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
    ];

    var parts = dateString.split('-'); // Pisahkan tahun, bulan, tanggal
    var tahun = parts[0];
    var bulan = parseInt(parts[1]); // Ubah "06" jadi 6 (integer)
    var tanggal = parseInt(parts[2]); // Ubah "01" jadi 1 (hilangkan nol di depan)

    // Output: "19 Juni 2023"
    return tanggal + ' ' + namaBulan[bulan] + ' ' + tahun;
  }

  // --- FUNGSI BUKA PREVIEW FOTO ---
  var modalFoto;

  function openPhotoPreview(url) {
    if (!modalFoto) {
      modalFoto = new bootstrap.Modal(document.getElementById('modalFotoPreview'));
    }
    // Set sumber gambar modal sesuai url yang diklik
    document.getElementById('imgPreviewFull').src = url;
    modalFoto.show();
  }

</script>
