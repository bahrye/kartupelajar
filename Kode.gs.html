// --- KONFIGURASI UTAMA ---
var MASTER_SHEET_ID = '15ZvHQ2DEgKObLRlwAftz3jE5olP2h49t4bsdAFCYHho'; 
// ID Folder Utama (Tempat semua folder sekolah berkumpul)
var MAIN_PARENT_FOLDER_ID = '1Eu3dCTLw1l8xYs14TgYuYMm3wojo6fAV'; 

function doGet() {
  return HtmlService.createTemplateFromFile('Index')
      .evaluate()
      .setTitle('Aplikasi Kartu Pelajar')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// --- FUNGSI BARU: KIRIM OTP KE EMAIL ---
function sendRegistrationOTP(email, namaSekolah) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(5000);
    
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Users');
    var data = sheet.getDataRange().getValues();
    
    // 1. Cek Email Duplikat
    for(var i=0; i<data.length; i++){
      if(data[i][2] && data[i][2].toString().toLowerCase() == email.toLowerCase()) {
        return {status: 'error', message: 'Email sudah terdaftar! Silakan login.'};
      }
    }

    // 2. Generate OTP 6 Digit
    var otp = Math.floor(100000 + Math.random() * 900000).toString();

    // 3. Simpan OTP di CacheService (Berlaku 10 menit)
    var cache = CacheService.getScriptCache();
    cache.put("OTP_" + email, otp, 600); 

    // 4. Kirim Email
    var subject = "Kode Verifikasi Pendaftaran - " + namaSekolah;
    var body = "Halo Admin " + namaSekolah + ",\n\n" +
               "Berikut adalah kode verifikasi (OTP) untuk pendaftaran aplikasi kartu pelajar Anda:\n\n" +
               "KODE: " + otp + "\n\n" +
               "Kode ini berlaku selama 10 menit.\nJangan berikan kode ini kepada siapapun.";
    
    MailApp.sendEmail(email, subject, body);

    return {status: 'success', message: 'Kode OTP telah dikirim ke ' + email};

  } catch(e) {
    return {status: 'error', message: 'Gagal kirim email: ' + e.toString()};
  } finally {
    lock.releaseLock();
  }
}

// --- FUNGSI BARU: VERIFIKASI OTP & BUAT DATABASE ---
function verifyAndCreateAccount(form, userOtp) {
  var cache = CacheService.getScriptCache();
  var savedOtp = cache.get("OTP_" + form.email);

  // 1. Validasi OTP
  if (!savedOtp || savedOtp !== userOtp) {
    return {status: 'error', message: 'Kode OTP salah atau sudah kadaluarsa.'};
  }

  // 2. Jika OTP Benar, Jalankan Logika Pembuatan Database (Logika Lama dipindah kesini)
  // Hapus OTP dari cache agar tidak bisa dipakai ulang
  cache.remove("OTP_" + form.email);

  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000);
    
    // --- MULAI PROSES PEMBUATAN FILE (Logika asli registerSchool) ---
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Users');

    // Cek folder utama
    var parentFolder;
    try {
      parentFolder = DriveApp.getFolderById(MAIN_PARENT_FOLDER_ID);
    } catch(e) {
      return {status: 'error', message: 'Folder Induk Utama tidak ditemukan.'};
    }

    // Buat Folder Sekolah
    var schoolFolderName = "KARTU PELAJAR - " + form.namaSekolah;
    var schoolFolder = parentFolder.createFolder(schoolFolderName);

    // Buat Spreadsheet
    var newSS = SpreadsheetApp.create("DB_" + form.namaSekolah);
    var newSSId = newSS.getId();
    var fileSS = DriveApp.getFileById(newSSId);
    fileSS.moveTo(schoolFolder);

    // Buat Folder Foto
    var imgFolder = schoolFolder.createFolder("FOTO SISWA");
    var imgFolderId = imgFolder.getId();
    imgFolder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    // Setup Sheet
    var sheetSiswa = newSS.getSheets()[0];
    sheetSiswa.setName("DataSiswa");
    sheetSiswa.appendRow(["Nama", "NISN", "TempatLahir", "TglLahir", "JK", "Kelas", "Alamat", "FotoURL"]);
    sheetSiswa.appendRow(["Siswa Contoh", "'0012345678", "Jakarta", "2008-01-01", "P", "X-A", "Jl. Mawar No 1", "https://cdn.awsli.com.br/2500x2500/963/963818/produto/107131975/1cac5ba504.jpg"]);

    // Simpan Akun
    sheet.appendRow([new Date(), form.namaSekolah, form.email, form.password, newSSId, imgFolderId]);

    return {status: 'success', message: 'Verifikasi Berhasil! Database telah dibuat. Silakan Login.'};

  } catch(e) {
    return {status: 'error', message: 'Error Register: ' + e.toString()};
  } finally {
    lock.releaseLock();
  }
}

// --- LOGIN ---
function loginSchool(email, password) {
  try {
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Users');
    var data = sheet.getDataRange().getValues();
    
    for(var i=1; i<data.length; i++){
      if(data[i][2] == email && data[i][3] == password) {
        return {
          status: 'success', 
          token: data[i][4], 
          sekolah: data[i][1]
        };
      }
    }
    return {status: 'error', message: 'Email/Password salah.'};
  } catch(e) {
    return {status: 'error', message: 'Login Error.'};
  }
}

// --- HELPER: GET FOLDER ID ---
function getSchoolFolderId(schoolSpreadsheetId) {
  var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
  var sheet = ss.getSheetByName('Users');
  var data = sheet.getDataRange().getValues();
  
  for(var i=1; i<data.length; i++){
    if(data[i][4] == schoolSpreadsheetId) {
      return data[i][5]; 
    }
  }
  return null;
}

// --- HELPER UPLOAD FOTO ---
function processPhoto(fotoData, fileNamePrefix, targetFolderId) {
  if (!fotoData) return "";
  if (!fotoData.toString().startsWith("data:")) return fotoData; 

  try {
    var folder;
    if (targetFolderId) {
      folder = DriveApp.getFolderById(targetFolderId);
    } else {
      // Fallback
      var folderName = "APP_KARTU_PELAJAR_FOTO_FALLBACK";
      var folders = DriveApp.getFoldersByName(folderName);
      if (folders.hasNext()) {
        folder = folders.next();
      } else {
        folder = DriveApp.createFolder(folderName);
        folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      }
    }

    // Decode & Save
    var split = fotoData.split('base64,');
    var contentType = split[0].split(':')[1].split(';')[0];
    var decoded = Utilities.base64Decode(split[1]);
    
    var fileName = fileNamePrefix + "_" + new Date().getTime(); 
    var blob = Utilities.newBlob(decoded, contentType, fileName);

    var file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    return "https://drive.google.com/thumbnail?sz=w800&id=" + file.getId();

  } catch (e) {
    Logger.log("GAGAL UPLOAD FOTO: " + e.toString());
    return "UPLOAD_FAILED"; 
  }
}

// --- CRUD SISWA ---

// 1. READ (DENGAN FIX TANGGAL MUNDUR)
function getStudents(spreadsheetId) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    var data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) return {status: 'success', data: []}; 

    data.shift(); // Hapus Header
    
    var students = data.map(function(r, index){
      
      // --- LOGIKA PERBAIKAN TANGGAL ---
      var tglFix = "";
      if (r[3]) {
        // Buat object Date dari data sheet
        var d = new Date(r[3]);
        
        // TRICK: Set jam ke 12:00 Siang
        // Masalah tanggal mundur terjadi karena jam default adalah 00:00.
        // Jika kena timezone offset (-7 jam), dia jadi jam 17:00 HARI SEBELUMNYA.
        // Dengan set jam 12:00, jika kena offset pun dia masih jam 05:00 PAGI di HARI YANG SAMA.
        d.setHours(12);
        
        tglFix = Utilities.formatDate(d, "GMT+7", "yyyy-MM-dd");
      }
      // -------------------------------

      return {
        row: index + 2, 
        nama: r[0], 
        nisn: r[1].toString(), 
        tmp_lahir: r[2],
        tgl_lahir: tglFix, // Gunakan variabel yang sudah di-fix
        jk: r[4],
        kelas: r[5],
        alamat: r[6], 
        foto: r[7]
      };
    });
    
    return {status: 'success', data: students};
  } catch(e) {
    return {status: 'error', message: 'Gagal ambil data: ' + e.toString()};
  }
}

// 2. CREATE
function addStudent(spreadsheetId, s) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    var nisnText = "'" + s.nisn;
    
    var folderId = getSchoolFolderId(spreadsheetId);
    var finalFotoUrl = processPhoto(s.foto, s.nama, folderId);

    sheet.appendRow([s.nama, nisnText, s.tmp_lahir, s.tgl_lahir, s.jk, s.kelas, s.alamat, finalFotoUrl]);
    return {status: 'success', message: 'Data berhasil ditambahkan'};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}

// 3. UPDATE
function editStudent(spreadsheetId, s) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    var row = parseInt(s.row);
    var nisnText = "'" + s.nisn;
    
    var folderId = getSchoolFolderId(spreadsheetId);
    var finalFotoUrl = processPhoto(s.foto, s.nama, folderId);
    
    var range = sheet.getRange(row, 1, 1, 8);
    range.setValues([[s.nama, nisnText, s.tmp_lahir, s.tgl_lahir, s.jk, s.kelas, s.alamat, finalFotoUrl]]);
    
    return {status: 'success', message: 'Data berhasil diupdate'};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}

// 4. DELETE
function deleteStudent(spreadsheetId, row) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    sheet.deleteRow(parseInt(row));
    return {status: 'success', message: 'Data berhasil dihapus'};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}

// --- KONFIGURASI SEKOLAH (SETTINGS) ---

function saveSchoolConfig(spreadsheetId, configForm) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('Config');
    
    if (!sheet) {
      sheet = ss.insertSheet('Config');
      sheet.appendRow(['Key', 'Value']); 
    }
    
    // Tambahkan 'schoolType' ke dalam map
    var dataMap = {
      'schoolType': configForm.schoolType, // <--- TAMBAHAN PENTING
      'dinas': configForm.dinas,
      'yayasan': configForm.yayasan,
      'alamat1': configForm.alamat1,
      'alamat2': configForm.alamat2,
      'tgl': configForm.tgl,
      'kepala': configForm.kepala,
      'nip': configForm.nip,
      'telp': configForm.telp,
      'email': configForm.email,
      'logoKiri': configForm.logoKiri,
      'logoKanan': configForm.logoKanan,
      'stempel': configForm.stempel,
      'ttd': configForm.ttd,
      'bgImage': configForm.bgImage
    };

    // ... sisa kode di bawah ini sama seperti sebelumnya ...
    if (sheet.getLastRow() > 1) {
      sheet.getRange(2, 1, sheet.getLastRow()-1, 2).clearContent();
    }

    var rows = [];
    for (var key in dataMap) {
      var val = dataMap[key] || "";
      if (key === 'nip' || key === 'telp') {
        val = "'" + val; 
      }
      rows.push([key, val]);
    }

    if (rows.length > 0) {
      var range = sheet.getRange(2, 1, rows.length, 2);
      sheet.getRange(2, 2, rows.length, 1).setNumberFormat('@'); 
      range.setValues(rows);
    }

    return {status: 'success', message: 'Pengaturan berhasil disimpan!'};

  } catch(e) {
    return {status: 'error', message: 'Gagal simpan config: ' + e.toString()};
  }
}

// 2. LOAD CONFIG
function getSchoolConfig(spreadsheetId) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('Config');
    if (!sheet) return {status: 'empty', data: {}};

    var data = sheet.getDataRange().getValues();
    var config = {};
    
    // Loop dari baris ke-2 (index 1) karena baris 1 header
    for (var i = 1; i < data.length; i++) {
      var key = data[i][0];
      var val = data[i][1];
      config[key] = val;
    }
    
    return {status: 'success', data: config};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}

// --- FUNGSI IMPORT BULK (EXCEL/CSV SAMA SAJA) ---
function importBulkStudents(spreadsheetId, dataSiswa) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    
    var rowsToInsert = dataSiswa.map(function(s) {
      // Tambahkan tanda petik pada NISN agar terbaca string di Google Sheets
      var nisn = "'" + (s.nisn || "");
      
      return [
        s.nama, 
        nisn, 
        s.tmp_lahir, 
        s.tgl_lahir, 
        s.jk, 
        s.kelas, 
        s.alamat, 
        "" // Foto kosong
      ];
    });

    if (rowsToInsert.length > 0) {
      var lastRow = sheet.getLastRow();
      sheet.getRange(lastRow + 1, 1, rowsToInsert.length, 8).setValues(rowsToInsert);
    }

    return {status: 'success', message: 'Berhasil mengimport ' + rowsToInsert.length + ' data siswa.'};
    
  } catch(e) {
    return {status: 'error', message: 'Gagal Import: ' + e.toString()};
  }
}

// --- FUNGSI BULK PHOTO UPLOAD ---
function processBulkPhotos(spreadsheetId, zipBase64) {
  try {
    // 1. Decode ZIP dari Base64
    var blob = Utilities.newBlob(Utilities.base64Decode(zipBase64), 'application/zip', 'photos.zip');
    
    // 2. Unzip Files
    // Utilities.unzip mengembalikan array of blobs
    var files = Utilities.unzip(blob);
    
    if (files.length === 0) {
      return {status: 'error', message: 'File ZIP kosong atau rusak.'};
    }

    // 3. Siapkan Spreadsheet & Folder
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    var data = sheet.getDataRange().getValues(); // Ambil semua data siswa
    var folderId = getSchoolFolderId(spreadsheetId); // Ambil ID folder foto sekolah ini
    var folder = DriveApp.getFolderById(folderId);

    // 4. Buat Peta (Map) NISN -> Baris Index
    // Agar pencarian cepat, kita masukkan NISN ke dalam object map
    // Key: NISN, Value: Nomor Baris (mulai 0 di array data, atau +1 di sheet)
    var nisnMap = {};
    for (var i = 1; i < data.length; i++) { // Mulai i=1 karena header
      var nisn = data[i][1].toString().replace(/'/g, '').trim(); // Bersihkan NISN
      if (nisn) {
        nisnMap[nisn] = i + 1; // Simpan index baris (Row Number Excel)
      }
    }

    var successCount = 0;

    // 5. Loop setiap file foto dalam ZIP
    for (var f = 0; f < files.length; f++) {
      var fileBlob = files[f];
      var fileName = fileBlob.getName();
      
      // Abaikan folder atau file hidden (__MACOSX dll)
      if (fileName.startsWith('__') || fileBlob.getContentType() === 'application/octet-stream') continue;

      // Ambil nama file tanpa ekstensi (Contoh: "12345.jpg" -> "12345")
      var cleanName = fileName.split('.').slice(0, -1).join('.');
      
      // Cek apakah nama file ini ada di daftar NISN siswa?
      if (nisnMap[cleanName]) {
        var row = nisnMap[cleanName];
        
        // Simpan File ke Drive
        // Kita beri nama file baru agar rapi: "NamaSiswa_NISN_Timestamp"
        // Tapi "cleanName" (NISN) saja juga cukup untuk nama file di Drive
        fileBlob.setName(cleanName + "_" + new Date().getTime());
        var newFile = folder.createFile(fileBlob);
        newFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        
        var fileUrl = "https://drive.google.com/thumbnail?sz=w800&id=" + newFile.getId();

        // Update Kolom Foto (Kolom H / Index 8)
        sheet.getRange(row, 8).setValue(fileUrl);
        
        successCount++;
      }
    }

    return {
      status: 'success', 
      message: 'Berhasil memproses ' + files.length + ' file.\n' + successCount + ' foto siswa berhasil dicocokkan & diupload.'
    };

  } catch (e) {
    return {status: 'error', message: 'Error ZIP: ' + e.toString()};
  }
}

// --- 5. BULK DELETE (HAPUS MASSAL) ---
function deleteBulkStudents(spreadsheetId, rowsToDelete) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000); // Tunggu antrian agar tidak bentrok
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    
    // PENTING: Urutkan baris dari besar ke kecil (Descending)
    // Agar saat baris bawah dihapus, index baris atas tidak berubah
    rowsToDelete.sort(function(a, b){return b - a});
    
    for (var i = 0; i < rowsToDelete.length; i++) {
      var row = parseInt(rowsToDelete[i]);
      // Pastikan row valid
      if (row > 0) {
        sheet.deleteRow(row);
      }
    }
    
    return {status: 'success', message: rowsToDelete.length + ' data berhasil dihapus.'};
    
  } catch(e) {
    return {status: 'error', message: 'Gagal Hapus Massal: ' + e.toString()};
  } finally {
    lock.releaseLock();
  }
}

// [Kode.gs]
function getGlobalTemplates() {
  try {
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Templates');
    
    if (!sheet) return [];
    
    var data = sheet.getDataRange().getValues();
    
    // Hapus header (baris 1)
    if (data.length > 0) data.shift();
    
    var templates = data.map(function(row){
      return {
        name: row[0],         // Kolom A: Nama
        url: row[1],          // Kolom B: URL Background
        // Kolom C digunakan untuk Default Preview (dilewati di sini)
        layoutType: row[3]    // Kolom D: KATA KUNCI (Dinas / BiruPutih)
      };
    });
    
    // Filter yang kosong
    return templates.filter(function(t){ return t.name && t.url });
    
  } catch (e) {
    return [];
  }
}

// --- FUNGSI BARU: AMBIL BACKGROUND DEFAULT UNTUK PREVIEW ---
function getDefaultPreviewBg() {
  try {
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Templates');
    if (!sheet) return ""; // Return kosong jika sheet tidak ada

    var data = sheet.getDataRange().getValues();
    
    // Loop dari baris ke-2 (index 1) untuk mencari tanda "YA" di kolom C (index 2)
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var marker = row[2] ? row[2].toString().toUpperCase() : ""; // Kolom C
      
      if (marker === "YA") {
        return row[1]; // Kembalikan URL dari Kolom B
      }
    }
    
    // Jika tidak ada yang ditandai YA, kembalikan URL baris pertama sebagai fallback
    if (data.length > 1) return data[1][1];
    
    return "";
  } catch (e) {
    return "";
  }
}

// --- [FITUR BARU] RESET PASSWORD ---

// 1. Cek Email & Kirim OTP Reset
function sendResetOTP(email) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(5000);
    
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Users');
    var data = sheet.getDataRange().getValues();
    var userFound = false;
    var namaSekolah = "";

    // Cek apakah email terdaftar
    for(var i=1; i<data.length; i++){
      if(data[i][2] && data[i][2].toString().toLowerCase() == email.toLowerCase()) {
        userFound = true;
        namaSekolah = data[i][1]; // Ambil nama sekolah
        break;
      }
    }

    if (!userFound) {
      return {status: 'error', message: 'Email tidak terdaftar dalam sistem kami.'};
    }

    // Generate OTP
    var otp = Math.floor(100000 + Math.random() * 900000).toString();

    // Simpan di Cache (Prefix beda dengan register agar tidak bentrok)
    var cache = CacheService.getScriptCache();
    cache.put("RESET_OTP_" + email, otp, 600); // 10 Menit

    // Kirim Email
    var subject = "Kode Reset Password - " + namaSekolah;
    var body = "Halo Admin " + namaSekolah + ",\n\n" +
               "Kami menerima permintaan untuk mereset kata sandi akun Anda.\n" +
               "Berikut adalah kode verifikasi (OTP) Anda:\n\n" +
               "KODE: " + otp + "\n\n" +
               "Jika Anda tidak merasa meminta reset password, abaikan email ini.";
    
    MailApp.sendEmail(email, subject, body);

    return {status: 'success', message: 'Kode OTP telah dikirim ke ' + email};

  } catch(e) {
    return {status: 'error', message: 'Gagal kirim email: ' + e.toString()};
  } finally {
    lock.releaseLock();
  }
}

// 2. Verifikasi OTP & Simpan Password Baru
function confirmResetPassword(email, otp, newPass) {
  var cache = CacheService.getScriptCache();
  var savedOtp = cache.get("RESET_OTP_" + email);

  if (!savedOtp || savedOtp !== otp) {
    return {status: 'error', message: 'Kode OTP salah atau sudah kadaluarsa.'};
  }

  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000);
    
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Users');
    var data = sheet.getDataRange().getValues();
    
    // Cari baris user dan update password
    for(var i=1; i<data.length; i++){
      if(data[i][2] && data[i][2].toString().toLowerCase() == email.toLowerCase()) {
        // Update Kolom D (Index 3) -> Password
        // Baris di sheet adalah i+1 karena array mulai dari 0 tapi sheet row mulai dari 1
        sheet.getRange(i + 1, 4).setValue(newPass); 
        
        // Hapus OTP
        cache.remove("RESET_OTP_" + email);
        
        return {status: 'success', message: 'Password berhasil diubah! Silakan login.'};
      }
    }
    
    return {status: 'error', message: 'User tidak ditemukan saat update.'};

  } catch(e) {
    return {status: 'error', message: 'Gagal update password: ' + e.toString()};
  } finally {
    lock.releaseLock();
  }
}
