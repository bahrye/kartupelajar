// --- KONFIGURASI UTAMA ---
var MASTER_SHEET_ID = '15ZvHQ2DEgKObLRlwAftz3jE5olP2h49t4bsdAFCYHho'; 
// ID Folder Utama (Tempat semua folder sekolah berkumpul)
var MAIN_PARENT_FOLDER_ID = '1Eu3dCTLw1l8xYs14TgYuYMm3wojo6fAV'; 

function doGet() {
  return HtmlService.createTemplateFromFile('Index')
      .evaluate()
      .setTitle('Aplikasi Kartu Pelajar')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// --- FUNGSI REGISTRASI (DENGAN PEMINDAHAN DATABASE KE FOLDER) ---
function registerSchool(form) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000); 
  } catch (e) {
    return {status: 'error', message: 'Server sibuk.'};
  }

  try {
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Users');
    var data = sheet.getDataRange().getValues();
    
    // Cek Email Duplikat
    for(var i=0; i<data.length; i++){
      if(data[i][2] && data[i][2].toString().toLowerCase() == form.email.toLowerCase()) {
        return {status: 'error', message: 'Email sudah terdaftar!'};
      }
    }

    // --- 1. SIAPKAN FOLDER UTAMA ---
    var parentFolder;
    try {
      parentFolder = DriveApp.getFolderById(MAIN_PARENT_FOLDER_ID);
    } catch(e) {
      return {status: 'error', message: 'Folder Induk Utama tidak ditemukan (Cek ID Folder).'};
    }

    // Buat Folder Khusus Sekolah Ini
    var schoolFolderName = "KARTU PELAJAR - " + form.namaSekolah;
    var schoolFolder = parentFolder.createFolder(schoolFolderName);

    // --- 2. BUAT DATABASE SPREADSHEET ---
    // Secara default, create() akan meletakkan file di Root (My Drive)
    var newSS = SpreadsheetApp.create("DB_" + form.namaSekolah);
    var newSSId = newSS.getId();
    
    // >> PINDAHKAN FILE SPREADSHEET KE DALAM FOLDER SEKOLAH <<
    var fileSS = DriveApp.getFileById(newSSId);
    fileSS.moveTo(schoolFolder); // Ini perintah kuncinya

    // --- 3. BUAT FOLDER FOTO SISWA ---
    // Folder ini dibuat DI DALAM folder sekolah
    var imgFolder = schoolFolder.createFolder("FOTO SISWA");
    var imgFolderId = imgFolder.getId();
    
    // Set Permission Folder Foto (Public View)
    imgFolder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    // --- 4. SETUP ISI DATABASE ---
    var sheetSiswa = newSS.getSheets()[0];
    sheetSiswa.setName("DataSiswa");
    sheetSiswa.appendRow(["Nama", "NISN", "TempatLahir", "TglLahir", "JK", "Kelas", "Alamat", "FotoURL"]);
    
    // Data Dummy
    sheetSiswa.appendRow(["Siswa Contoh", "'0012345678", "Jakarta", "2008-01-01", "L", "X-A", "Jl. Mawar No 1", "https://via.placeholder.com/150"]);

    // --- 5. SIMPAN AKUN KE MASTER SHEET ---
    // Format: [Date, NamaSekolah, Email, Password, SS_ID, FOLDER_ID_FOTO]
    sheet.appendRow([new Date(), form.namaSekolah, form.email, form.password, newSSId, imgFolderId]);

    return {status: 'success', message: 'Registrasi Berhasil! Database & Folder telah dibuat.'};

  } catch(e) {
    return {status: 'error', message: 'Error Register: ' + e.toString()};
  } finally {
    lock.releaseLock();
  }
}

// --- LOGIN ---
function loginSchool(email, password) {
  try {
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Users');
    var data = sheet.getDataRange().getValues();
    
    for(var i=1; i<data.length; i++){
      if(data[i][2] == email && data[i][3] == password) {
        return {
          status: 'success', 
          token: data[i][4], 
          sekolah: data[i][1]
        };
      }
    }
    return {status: 'error', message: 'Email/Password salah.'};
  } catch(e) {
    return {status: 'error', message: 'Login Error.'};
  }
}

// --- HELPER: GET FOLDER ID ---
function getSchoolFolderId(schoolSpreadsheetId) {
  var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
  var sheet = ss.getSheetByName('Users');
  var data = sheet.getDataRange().getValues();
  
  for(var i=1; i<data.length; i++){
    if(data[i][4] == schoolSpreadsheetId) {
      return data[i][5]; 
    }
  }
  return null;
}

// --- HELPER UPLOAD FOTO ---
function processPhoto(fotoData, fileNamePrefix, targetFolderId) {
  if (!fotoData) return "";
  if (!fotoData.toString().startsWith("data:")) return fotoData; 

  try {
    var folder;
    if (targetFolderId) {
      folder = DriveApp.getFolderById(targetFolderId);
    } else {
      // Fallback
      var folderName = "APP_KARTU_PELAJAR_FOTO_FALLBACK";
      var folders = DriveApp.getFoldersByName(folderName);
      if (folders.hasNext()) {
        folder = folders.next();
      } else {
        folder = DriveApp.createFolder(folderName);
        folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      }
    }

    // Decode & Save
    var split = fotoData.split('base64,');
    var contentType = split[0].split(':')[1].split(';')[0];
    var decoded = Utilities.base64Decode(split[1]);
    
    var fileName = fileNamePrefix + "_" + new Date().getTime(); 
    var blob = Utilities.newBlob(decoded, contentType, fileName);

    var file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    return "https://drive.google.com/uc?export=view&id=" + file.getId();

  } catch (e) {
    Logger.log("GAGAL UPLOAD FOTO: " + e.toString());
    return "UPLOAD_FAILED"; 
  }
}

// --- CRUD SISWA ---

// 1. READ
function getStudents(spreadsheetId) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    var data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) return {status: 'success', data: []}; 

    data.shift(); // Hapus Header
    
    var students = data.map(function(r, index){
      return {
        row: index + 2, 
        nama: r[0], 
        nisn: r[1].toString(), 
        tmp_lahir: r[2],
        tgl_lahir: r[3] ? Utilities.formatDate(new Date(r[3]), "GMT+7", "yyyy-MM-dd") : "",
        jk: r[4],
        kelas: r[5],
        alamat: r[6], 
        foto: r[7]
      };
    });
    
    return {status: 'success', data: students};
  } catch(e) {
    return {status: 'error', message: 'Gagal ambil data: ' + e.toString()};
  }
}

// 2. CREATE
function addStudent(spreadsheetId, s) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    var nisnText = "'" + s.nisn;
    
    var folderId = getSchoolFolderId(spreadsheetId);
    var finalFotoUrl = processPhoto(s.foto, s.nama, folderId);

    sheet.appendRow([s.nama, nisnText, s.tmp_lahir, s.tgl_lahir, s.jk, s.kelas, s.alamat, finalFotoUrl]);
    return {status: 'success', message: 'Data berhasil ditambahkan'};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}

// 3. UPDATE
function editStudent(spreadsheetId, s) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    var row = parseInt(s.row);
    var nisnText = "'" + s.nisn;
    
    var folderId = getSchoolFolderId(spreadsheetId);
    var finalFotoUrl = processPhoto(s.foto, s.nama, folderId);
    
    var range = sheet.getRange(row, 1, 1, 8);
    range.setValues([[s.nama, nisnText, s.tmp_lahir, s.tgl_lahir, s.jk, s.kelas, s.alamat, finalFotoUrl]]);
    
    return {status: 'success', message: 'Data berhasil diupdate'};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}

// 4. DELETE
function deleteStudent(spreadsheetId, row) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    sheet.deleteRow(parseInt(row));
    return {status: 'success', message: 'Data berhasil dihapus'};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}
