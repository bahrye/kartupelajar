// --- KONFIGURASI UTAMA ---
var MASTER_SHEET_ID = '15ZvHQ2DEgKObLRlwAftz3jE5olP2h49t4bsdAFCYHho'; 

function doGet() {
  return HtmlService.createTemplateFromFile('Index')
      .evaluate()
      .setTitle('Aplikasi Kartu Pelajar')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// --- FUNGSI REGISTRASI ---
function registerSchool(form) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000); 
  } catch (e) {
    return {status: 'error', message: 'Server sibuk.'};
  }

  try {
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Users');
    var data = sheet.getDataRange().getValues();
    
    // Cek Email Duplikat
    for(var i=0; i<data.length; i++){
      if(data[i][2] && data[i][2].toString().toLowerCase() == form.email.toLowerCase()) {
        return {status: 'error', message: 'Email sudah terdaftar!'};
      }
    }

    // Buat Spreadsheet Baru
    var newSS = SpreadsheetApp.create("DB_" + form.namaSekolah);
    var newSSId = newSS.getId();
    
    // Setup Header Data Siswa
    var sheetSiswa = newSS.getSheets()[0];
    sheetSiswa.setName("DataSiswa");
    sheetSiswa.appendRow(["Nama", "NISN", "TempatLahir", "TglLahir", "JK", "Kelas", "Alamat", "FotoURL"]);
    
    // Data Dummy (Format NISN dengan kutip satu agar terbaca teks)
    sheetSiswa.appendRow(["Siswa Contoh", "'0012345678", "Jakarta", "2008-01-01", "L", "X-A", "Jl. Mawar No 1", "https://via.placeholder.com/150"]);

    // Simpan Akun
    sheet.appendRow([new Date(), form.namaSekolah, form.email, form.password, newSSId]);

    return {status: 'success', message: 'Registrasi Berhasil!'};

  } catch(e) {
    return {status: 'error', message: 'Error: ' + e.toString()};
  } finally {
    lock.releaseLock();
  }
}

// --- LOGIN ---
function loginSchool(email, password) {
  try {
    var ss = SpreadsheetApp.openById(MASTER_SHEET_ID);
    var sheet = ss.getSheetByName('Users');
    var data = sheet.getDataRange().getValues();
    
    for(var i=1; i<data.length; i++){
      if(data[i][2] == email && data[i][3] == password) {
        return {
          status: 'success', 
          token: data[i][4], 
          sekolah: data[i][1]
        };
      }
    }
    return {status: 'error', message: 'Email/Password salah.'};
  } catch(e) {
    return {status: 'error', message: 'Login Error.'};
  }
}

// --- CRUD SISWA ---

// 1. READ (Ambil Data)
function getStudents(spreadsheetId) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    var data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) return {status: 'success', data: []}; 

    data.shift(); // Hapus Header
    
    var students = data.map(function(r, index){
      return {
        row: index + 2, 
        nama: r[0], 
        // Ubah ke string agar aman saat dikirim ke frontend
        nisn: r[1].toString(), 
        tmp_lahir: r[2],
        tgl_lahir: r[3] ? Utilities.formatDate(new Date(r[3]), "GMT+7", "yyyy-MM-dd") : "",
        jk: r[4],
        kelas: r[5],
        alamat: r[6], 
        foto: r[7]
      };
    });
    
    return {status: 'success', data: students};
  } catch(e) {
    return {status: 'error', message: 'Gagal ambil data: ' + e.toString()};
  }
}

// --- HELPER UPLOAD FOTO KE DRIVE (VERSI PERBAIKAN) ---
function processPhoto(fotoData, fileNamePrefix) {
  // 1. Cek apakah ini data base64 (foto baru) atau URL lama
  if (!fotoData) return "";
  if (!fotoData.toString().startsWith("data:")) return fotoData;

  try {
    // 2. Cari/Buat Folder Khusus
    var folderName = "APP_KARTU_PELAJAR_FOTO";
    var folders = DriveApp.getFoldersByName(folderName);
    var folder;
    if (folders.hasNext()) {
      folder = folders.next();
    } else {
      folder = DriveApp.createFolder(folderName);
      folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    }

    // 3. Decode Base64 & Buat Blob
    var split = fotoData.split('base64,');
    var contentType = split[0].split(':')[1].split(';')[0];
    var decoded = Utilities.base64Decode(split[1]);
    // Tambahkan timestamp agar nama file unik
    var fileName = fileNamePrefix + "_" + new Date().getTime(); 
    var blob = Utilities.newBlob(decoded, contentType, fileName);

    // 4. Simpan File ke Drive
    var file = folder.createFile(blob);
    
    // 5. Pastikan File bisa diakses publik
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    // 6. KEMBALIKAN LINK YANG VALID (Ini kuncinya)
    // Menggunakan format export=view agar bisa tampil di tag <img>
    return "https://drive.google.com/uc?export=view&id=" + file.getId();

  } catch (e) {
    // Jika error, kita log ke console tapi JANGAN return string kosong begitu saja
    // Agar kita tahu di mana salahnya.
    Logger.log("GAGAL UPLOAD FOTO: " + e.toString());
    // Kembalikan string kosong agar data siswa tetap tersimpan meski foto gagal
    return ""; 
  }
}

// 2. CREATE (Tambah Siswa)
function addStudent(spreadsheetId, s) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    
    var nisnText = "'" + s.nisn;
    
    // PROSES UPLOAD FOTO
    var finalFotoUrl = processPhoto(s.foto, s.nama);

    sheet.appendRow([s.nama, nisnText, s.tmp_lahir, s.tgl_lahir, s.jk, s.kelas, s.alamat, finalFotoUrl]);
    return {status: 'success', message: 'Data berhasil ditambahkan'};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}

// 3. UPDATE (Edit Siswa)
function editStudent(spreadsheetId, s) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    var row = parseInt(s.row);
    
    var nisnText = "'" + s.nisn;
    
    // PROSES UPLOAD FOTO (Hanya upload jika data yang dikirim adalah Base64 baru)
    var finalFotoUrl = processPhoto(s.foto, s.nama);
    
    var range = sheet.getRange(row, 1, 1, 8);
    range.setValues([[s.nama, nisnText, s.tmp_lahir, s.tgl_lahir, s.jk, s.kelas, s.alamat, finalFotoUrl]]);
    
    return {status: 'success', message: 'Data berhasil diupdate'};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}

// 4. DELETE (Hapus Siswa)
function deleteStudent(spreadsheetId, row) {
  try {
    var ss = SpreadsheetApp.openById(spreadsheetId);
    var sheet = ss.getSheetByName('DataSiswa');
    sheet.deleteRow(parseInt(row));
    return {status: 'success', message: 'Data berhasil dihapus'};
  } catch(e) {
    return {status: 'error', message: e.toString()};
  }
}

// --- FITUR PERBAIKAN DATA (Jalankan Manual Sekali Saja) ---
function fixMissingPhotos() {
  // Ganti ID Spreadsheet DB Sekolah Anda di sini (bukan Master Sheet ID)
  // Anda bisa ambil ID ini dari URL Spreadsheet database sekolah yang error.
  var DB_SPREADSHEET_ID = '1hjqK5Nd1vFEpGPhApI-6oGt7BzdOJ_SIaBoTG5Vr6CU'; 

  var ss = SpreadsheetApp.openById(DB_SPREADSHEET_ID);
  var sheet = ss.getSheetByName('DataSiswa');
  var data = sheet.getDataRange().getValues();
  
  // Ambil folder foto
  var folderName = "APP_KARTU_PELAJAR_FOTO";
  var folders = DriveApp.getFoldersByName(folderName);
  if (!folders.hasNext()) {
    Logger.log("Folder foto tidak ditemukan!");
    return;
  }
  var folder = folders.next();
  var files = folder.getFiles();
  
  // Buat index file berdasarkan nama untuk pencarian cepat
  var fileMap = {};
  while (files.hasNext()) {
    var file = files.next();
    // Key-nya adalah nama file (misal: Budi_167888.jpg)
    fileMap[file.getName()] = file.getId();
    // Pastikan akses publik sekalian
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  }

  var updatedCount = 0;

  // Loop data siswa (Mulai dari baris 2 karena header)
  for (var i = 1; i < data.length; i++) {
    var namaSiswa = data[i][0]; // Kolom Nama
    var currentFoto = data[i][7]; // Kolom FotoURL
    
    // Hanya perbaiki jika kolom foto kosong atau cuma strip "-"
    if (!currentFoto || currentFoto.length < 10) {
      
      // Cari file di map yang namanya MENGANDUNG nama siswa
      for (var fileName in fileMap) {
        if (fileName.indexOf(namaSiswa) > -1) {
          // KETEMU! Generate Link Baru
          var newLink = "https://drive.google.com/uc?export=view&id=" + fileMap[fileName];
          
          // Update Data di Array
          sheet.getRange(i + 1, 8).setValue(newLink);
          Logger.log("Fixing foto untuk: " + namaSiswa);
          updatedCount++;
          break; // Lanjut ke siswa berikutnya
        }
      }
    }
  }
  
  Logger.log("Selesai! Total foto diperbaiki: " + updatedCount);
}
